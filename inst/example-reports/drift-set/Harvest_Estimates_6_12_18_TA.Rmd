---
title: "Harvest Estimates: 6/12/2018 Subsistence Opportunity"
author: "Prepared by USFWS"
date: "CORRECTED"
output: pdf_document
geometry: margin=0.5in
linkcolor: "blue"
---

---

```{r Markdown Setup, include = F}
knitr::opts_chunk$set(echo = FALSE, fig.align = "center", warning = F, message = F)
```

```{r Session Setup}
library(pander)

# clear the workspace
rm(list = ls(all = T))

# the directory where all data files are located
data_dir = "C:/Users/bstaton/Documents/StatonWork/2_Harvest Estimates/6_12_18_TA/"

# read functions into workspace
message = F
# source("C:/Users/bas0041/Dropbox/PhD Project/USFWS Work/2017/Inseason Harvest Estimates/Functions_Source.R")
source("C:/Users/bstaton/Documents/StatonWork/2_Harvest Estimates/Functions_Source.R")

# set global table option to never break table on two rows
panderOptions(o = "table.split.table", value = Inf) 

# number of bootstrapped samples
n.boot = 10000

# set the random seed to always get same estimates.
set.seed(1)

# decide if you want to include the various appendicies
doA = T
doB = T
includeProgress = F  # decide if you want to include the progress plot. MUST BE FALSE IF !doB

# decide if you want to write the output files
do.write = T

# the date in file names
dFile = "6_12_18"

```

```{r Dates to Keep}
# the dates to keep in the rest of the analysis.
# THIS IS KEY, OTHERWISE YOU COULD USE THE WRONG CATCH AND EFFORT DATA!!!
keep.dates = c("6/12")
```

```{r Step 1: Prepare All Data}
# the columns in the right order for all interview data sets
cols = c("source", "date", "stratum", "trip.start", "trip.end", "soak.hrs", "length", 
         "gear", "mesh", "chinook", "chum", "sockeye", "chinook.cpe", "chum.cpe", "sockeye.cpe")

# read in raw interview files
cbm.raw.dat = read.csv(paste(data_dir, file_name("CBM", dFile), sep = "/"), stringsAsFactors = F)
bbh.raw.dat = read.csv(paste(data_dir, file_name("BBH", dFile), sep = "/"), stringsAsFactors = F)
adfg.raw.dat = read.csv(paste(data_dir, file_name("ADFG", dFile), sep = "/"), stringsAsFactors = F)
fc.raw.dat = read.csv(paste(data_dir, file_name("FC", dFile), sep = "/"), stringsAsFactors = F)
le.raw.dat = read.csv(paste(data_dir, file_name("LE", dFile), sep = "/"), stringsAsFactors = F)

# read in raw flight data
flight.dat.raw = read.csv(paste(data_dir, file_name("Flight_counts2", dFile), sep = "/"), stringsAsFactors = F)

# PREPARE BETHEL BOAT HARBOR DATA
bbh.dat = bbh.prep(bbh.raw.dat)

# remove questionable entries for now
bbh.dat = bbh.dat[-which(bbh.dat$mesh > 8),]

# PREPARE COMMUNITY BASED MONITORING DATA
cbm.dat = cbm.prep(dat = cbm.raw.dat)
cbm.goals = cbm.dat$goals
cbm.dat = cbm.dat$catch.effort

# PREPARE ADFG DATA FROM KASIGLUK
adfg.dat = cbm.prep(dat = adfg.raw.dat)
adfg.goals = adfg.dat$goals
adfg.dat = adfg.dat$catch.effort
adfg.dat$source = "ADFG"

# PREPARE BETHEL AREA FISH CAMP DATA
fc.dat = fc.prep(dat = fc.raw.dat)

# PREPARE LAW ENFORCEMENT INTERVIEWS
le.dat = LE.prep(le.raw.dat)

# COMBINE ALL DATASETS INTO ONE
dat = rbind(bbh.dat, cbm.dat, adfg.dat, le.dat, fc.dat)

# KEEP ONLY THE DATES OF INTEREST
dat = dat[dat$date %in% keep.dates,]

# SEPARATE INTERVIEW DATA BY GEAR TYPES
drift.dat = dat[dat$gear == "drift",]
set.dat = dat[dat$gear == "set",]

# PREPARE FLIGHT DATA
flight.dat = flight.prep(dat = flight.dat.raw)

```

```{r Step 2: Generate Total Drift Effort Estimates}
trip.ests = estimate.trips(trips = drift.dat, 
                         f1.times = flight.dat$f1.times, num.f1 = flight.dat$drift.tot[1],
                         f2.times = flight.dat$f2.times, num.f2 = flight.dat$drift.tot[2],
                         f3.times = flight.dat$f3.times, num.f3 = flight.dat$drift.tot[3])

n.trips = unname(trip.ests["total.b"])

boat.trips = round(flight.dat$drift.p * n.trips)
set.nets = flight.dat$set.nets
```

```{r Step 3: Generate Harvest Estimates by Stratum}
# strata
strata = names(boat.trips)
n.strata = length(strata)

# pooling of information: which data should be used in each stratum?
# table(drift.dat$stratum)

use.A = c("A")
use.B = c("B")
use.C = c("C")
use.D1 = c("D1")

# containers: [iterations,species,strata]
rand.strat.drift = rand.strat.set = array(NA, dim = c(n.boot, 3, n.strata))
dimnames(rand.strat.drift) = dimnames(rand.strat.set) = list(1:n.boot, c("chinook", "chum", "sockeye"), strata)

keep.sources = c("CBM", "LE", "BBH", "FC", "ADFG")

# produce estimates with randomized data
for (i in 1:n.boot) {
  rand.strat.drift[i,,"A"] = estimate.harvest(dat = randomize.data(drift.dat[drift.dat$stratum %in% use.A & drift.dat$source %in% keep.sources,]), n.trips = unname(boat.trips["A"]))
  rand.strat.drift[i,,"B"] = estimate.harvest(dat = randomize.data(drift.dat[drift.dat$stratum %in% use.B & drift.dat$source %in% keep.sources,]), n.trips = unname(boat.trips["B"]))
  rand.strat.drift[i,,"C"] = estimate.harvest(dat = randomize.data(drift.dat[drift.dat$stratum %in% use.C & drift.dat$source %in% keep.sources,]), n.trips = unname(boat.trips["C"]))
  rand.strat.drift[i,,"D1"] = estimate.harvest(dat = randomize.data(drift.dat[drift.dat$stratum %in% use.D1 & drift.dat$source %in% keep.sources,]), n.trips = unname(boat.trips["D1"]))

  rand.strat.set[i,,"A"] = estimate.harvest(dat = randomize.data(set.dat), n.trips = unname(set.nets["A"]))
  rand.strat.set[i,,"B"] = estimate.harvest(dat = randomize.data(set.dat), n.trips = unname(set.nets["B"]))
  rand.strat.set[i,,"C"] = estimate.harvest(dat = randomize.data(set.dat), n.trips = unname(set.nets["C"]))
  rand.strat.set[i,,"D1"] = estimate.harvest(dat = randomize.data(set.dat), n.trips = unname(set.nets["D1"]))
  # rand.strat.set[i,,"A"] = 0
  # rand.strat.set[i,,"B"] = 0
  # rand.strat.set[i,,"C"] = 0
  # rand.strat.set[i,,"D1"] = 0
}

# estimate.harvest(dat = set.dat, n.trips = unname(set.nets["A"]))
# estimate.harvest(dat = set.dat, n.trips = unname(set.nets["B"]))
# estimate.harvest(dat = set.dat, n.trips = unname(set.nets["C"]))
# estimate.harvest(dat = set.dat, n.trips = unname(set.nets["D1"]))
# estimate.harvest(dat = drift.dat[drift.dat$stratum %in% use.A,], n.trips = unname(boat.trips["A"]))
# estimate.harvest(dat = drift.dat[drift.dat$stratum %in% use.B,], n.trips = unname(boat.trips["B"]))
# estimate.harvest(dat = drift.dat[drift.dat$stratum %in% use.C,], n.trips = unname(boat.trips["C"]))
# estimate.harvest(dat = drift.dat[drift.dat$stratum %in% use.D1,], n.trips = unname(boat.trips["D1"]))
```

```{r Step 4: Summarize Harvest Output}

# NOTATION
  # if includes 'rand', these are estimates for each random data set
  # if includes 'strat', these are stratified by geographic stratum
  # if includes 'tot', these are summed across strata but not necessarily across gears
  # if includes 'drift', these are drift harvests only
  # if includes 'set', these are set harvest only
  # all objects (except 'all.salmon' ones) have species as the second dimension!!

# randomized harvest by stratum across both gears
rand.strat = rand.strat.drift + rand.strat.set

# randomized total harvest by drift boats across strata
rand.tot.drift = apply(rand.strat.drift, 2, rowSums)

# randomized total harvest by set netsacross strata
rand.tot.set = apply(rand.strat.set, 2, rowSums)

# randomized total harvest across gears across strata
rand.tot = rand.tot.drift + rand.tot.set

# randomized all salmon harvest
rand.all.salmon = rowSums(rand.tot)

# summarized total harvest by gear
tot.drift = apply(rand.tot.drift, 2, rand.summ)
tot.set = apply(rand.tot.set, 2, rand.summ)

# summarized total harvest across gears
tot = apply(rand.tot, 2, rand.summ, pretty = T)
# apply(rand.tot, 2, function(x) sd(x)/mean(x))

# summarized total salmon harvest
all.salmon = rand.summ(rand.all.salmon, pretty = T)

# summaries by stratum
strat.drift = strat.set = strat.tot = array(NA, dim = c(3, 3, 4))
strat.all.salmon.drift = matrix(NA, 3,4); rownames(strat.all.salmon.drift) = rownames(tot); colnames(strat.all.salmon.drift) = strata
strat.all.salmon.set = matrix(NA, 3,4); rownames(strat.all.salmon.set) = rownames(tot); colnames(strat.all.salmon.set) = strata
strat.all.salmon.tot = matrix(NA, 3,4); rownames(strat.all.salmon.tot) = rownames(tot); colnames(strat.all.salmon.tot) = strata
dimnames(strat.drift) = dimnames(strat.set) = dimnames(strat.tot) = list(rownames(tot), colnames(tot), strata)
for (s in 1:n.strata) {
  strat.drift[,,strata[s]] = apply(rand.strat.drift[,,strata[s]], 2, rand.summ)
  strat.set[,,strata[s]] = apply(rand.strat.set[,,strata[s]], 2, rand.summ)
  strat.tot[,,strata[s]] = apply(rand.strat[,,strata[s]], 2, rand.summ)
  
  strat.all.salmon.drift[,s] = rand.summ(rowSums(rand.strat.drift[,,strata[s]]))
  strat.all.salmon.set[,s] = rand.summ(rowSums(rand.strat.set[,,strata[s]]))
  strat.all.salmon.tot[,s] = rand.summ(rowSums(rand.strat.drift[,,strata[s]]) + rowSums(rand.strat.set[,,strata[s]]))
}

# rand.summ(rowSums(apply(rand.strat.drift,3,rowSums)))
# rand.summ(rowSums(apply(rand.strat.set,3,rowSums)))
# rand.summ(rowSums(apply(rand.strat.drift + rand.strat.set,3,rowSums)))

# calculate total chinook salmon harvest below BTF
# rand.chin.btf = rand.strat[,"chinook","A"] + rand.strat[,"chinook","B"] + rand.strat[,"chinook","C"] * 0.5
# mean(rand.chin.btf); sd(rand.chin.btf)

# calculate the total salmon harvest by set nets
rand.all.salmon.set = rowSums(rand.tot.set)
all.salmon.set = rand.summ(rand.all.salmon.set)

# calculate the proportion of set net harvest by species
rand.p.spp.set = t(apply(rand.tot.set, 1, function(x) x/sum(x)))
p.spp.set = apply(rand.p.spp.set, 2, rand.summ, rnd = 2)
p.spp.set = p.spp.set["mean",] * 100

## QUANTITIES FOR TABLE 2 ##

# all salmon harvest per boat above and below johnson R.
rand.all.salmon.below = rowSums(rand.strat.drift[,,"A"])
rand.all.salmon.above = rowSums(rand.strat.drift[,"chinook",c("B", "C", "D1")] + rand.strat.drift[,"chum",c("B", "C", "D1")] + rand.strat.drift[,"sockeye",c("B", "C", "D1")])

rand.all.salmon.cpb.below = rand.all.salmon.below/sum(boat.trips["A"])
rand.all.salmon.cpb.above = rand.all.salmon.above/sum(boat.trips[c("B", "C", "D1")])
cpb.below = rand.summ(rand.all.salmon.cpb.below, rnd = 0)
cpb.above = rand.summ(rand.all.salmon.cpb.above, rnd = 0)

# species ratio
rand.cpb.below = rand.strat.drift[,,"A"]/boat.trips["A"]
rand.ratio.below = rowSums(rand.cpb.below[,c("chum", "sockeye")])/rand.cpb.below[,"chinook"]
rand.ratio.above = rowSums(rand.strat.drift[,"chum",c("B", "C", "D1")] + rand.strat.drift[,"sockeye",c("B", "C", "D1")])/rowSums(rand.strat.drift[,"chinook",c("B", "C", "D1")])

ratio.below = rand.summ(rand.ratio.below, rnd = 1)
ratio.above = rand.summ(rand.ratio.above, rnd = 1)

# drift.dat$ratio = rowSums(drift.dat[,c("chum", "sockeye")])/drift.dat$chinook
# drift.dat$ratio[drift.dat$ratio == "Inf" | is.na(drift.dat$ratio)] = NA
# drift.dat$region = ifelse(drift.dat$stratum %in% c("B", "C", "D1"), "above", "below")
# 
# drift.dat$all.salmon = rowSums(drift.dat[,c("chinook", "chum", "sockeye")])
# 
# with(drift.dat, tapply(all.salmon, region, rand.summ, rnd = 0))
# with(drift.dat, tapply(ratio, region, rand.summ, rnd = 2))
# with(drift.dat, tapply(ratio, region, rand.summ, rnd = 2))

```

```{r write output files, eval = do.write}

# write random estimates by strata and species for Driftnets
write.csv(x = ary_to_df(x = rand.strat.drift, date = keep.dates, gear = "drift"),
          file = file_name(type = "DriftOut", dFile = dFile), row.names = F)

# write random estimates by strata and species for Setnets
write.csv(x = ary_to_df(x = rand.strat.set, date = keep.dates, gear = "set"),
          file = file_name(type = "SetOut", dFile = dFile), row.names = F)

# total harvest
write.csv(as.data.frame(rand.tot), "Total Harvest_6_12_18_TA.csv", row.names = F)

# harvest downstream of BTF

# calculate fraction of C harvest that occurred DS of BTF by gear
pC = read.csv(paste(data_dir, file_name("pC", dFile), sep = "/"), stringsAsFactors = F)
pC_drift = mean(pC$pC[pC$gear == "drift"])
pC_set = mean(pC$pC[pC$gear == "set"])

# calculate harvest ds of btf
rand_btf_drift = rand.strat.drift[,,"A"] + rand.strat.drift[,,"B"] + rand.strat.drift[,,"C"] * pC_drift
rand_btf_set = rand.strat.set[,,"A"] + rand.strat.set[,,"B"] + rand.strat.set[,,"C"] * pC_set
rand_btf = rand_btf_drift + rand_btf_set

# write out
write.csv(rand_btf, "BTF Harvest_6_12_18_TA.csv", row.names = F)

```

This document presents harvest and effort estimates as well as fisher-trip information for the subsistence salmon fishery opportunity on the Kuskokwim River that occurred on June 12, 2018 within the Yukon Delta National Wildlife Refuge (YDNWR) boundaries. The production of these estimates was a highly collaborative effort between the U.S. Fish and Wildlife Service (USFWS), the Orutsararmuit Traditional Native Council (OTNC), the Alaska Department of Fish and Game (ADF&G) and the Kuskokwim River Inter-tribal Fisheries Commission (KRITFC) in cooperation with the Bering Sea Fisherman's Association (BSFA). **These estimates encompass harvest taken the portion of the main-stem Kuskokwim River between and including the villages of Tuntutuliak and Akiak**. Harvest and effort estimation was conducted by USFWS staff using the same methods as in [2016](https://www.fws.gov/uploadedFiles/2016KuskokwimSubsistenceSalmonHarvest.pdf) and [2017](https://www.fws.gov/uploadedFiles/2017KuskokwimRiverSubsistenceSalmonHarvest.pdf). Please contact Ben Staton (<benjamin_staton@fws.gov>) if you have any questions regarding these estimates.

## Opportunity Details

The YDNWR federal in-season manager, with authority delegated by the Federal Subsistence Board and in consultation with the KRITFC, announced a subsistence fishing opportunity for Chinook salmon within the YDNWR waters for federally-qualified subsistence users. The opportunity was 12 hours in duration, starting at 10:00AM June 12 and ending at 10:00PM June 12. The special action can be found [here](http://cmsstage.fws.doi.net/uploadedFiles/3-KS-04-18%20Final.pdf), and the corresponding news release [here](http://cmsstage.fws.doi.net/uploadedFiles/3-KS-04-18_News%20Release%20Final.pdf).

## Data Sources

* A total of **`r nrow(dat)`** fisher interviews were used in this analysis.
    * **`r nrow(dat[dat$source == "BBH",])`** fisher interviews collected by OTNC from the Bethel boat harbor were used (**`r nrow(dat[is.na(dat$soak.hrs) & dat$source == "BBH",])`** did not have soak time). 
    * **`r nrow(dat[dat$source == "FC",])`** fisher interviews collected by OTNC from Bethel area fish camps were used. 
    * **`r nrow(dat[dat$source == "CBM",])`** fisher interviews collected by KRITFC/BSFA community-based monitoring efforts were used. 
    * **`r nrow(dat[dat$source == "ADFG",])`** fisher interviews collected by ADF&G Division of Subsistence stationed in Kasigluk were used.
    * **`r nrow(dat[dat$source == "LE",])`** fisher interviews collected by USFWS law enforcement officers were used. 
* **`r nrow(dat[dat$gear == "drift",])`** interviews were from drift boat fishers.
* **`r nrow(dat[dat$gear == "set",])`** interviews were from set net fishers.
* USFWS flew **3** aerial surveys to count drift boats and set nets.

## Effort Estimates

* A total of **`r n.trips`** drift boat trips were estimated to have occurred during the opportunity.
* During aerial survey flights between Tuntutuliak and Akiak, we observed:
    * **`r flight.dat$drift.tot[1]`** drift boats between 11:00AM and 12:40PM,
    * **`r flight.dat$drift.tot[2]`** drift boats between 3:00PM and 5:00PM, and 
    * **`r flight.dat$drift.tot[3]`** drift boats between 7:00PM and 8:30PM.
* Of the drift boats counted on the second flight, we estimated that **`r round(trip.ests["p.old1"], 2) * 100`%** of them were also counted during the first flight.
* Of the drift boats counted on the third flight, we estimated that **`r round(trip.ests["p.old2"], 2) * 100`%** of them were also counted during the second flight.
* **`r round(trip.ests["trips.not.counted"])`** drift boat trips were estimated to have began and ended during times that were not flown.
* We observed **`r sum(set.nets)`** set nets fishing in the main-stem Kuskokwim River during the opportunity.

## Harvest Estimates

* An estimated total of **`r report(all.salmon)`** salmon were harvested.
    * An estimated total of **`r report(tot[,"chinook"])`** Chinook salmon were harvested.
    * An estimated total of **`r report(tot[,"chum"])`** chum salmon were harvested.
    * An estimated total of **`r report(tot[,"sockeye"])`** sockeye salmon were harvested.
* Harvest by set nets accounted for an estimated **`r report(all.salmon.set)`** total salmon (**`r p.spp.set["chinook"]`%** Chinook salmon, **`r p.spp.set["chum"]`%** chum salmon, and **`r p.spp.set["sockeye"]`%** sockeye salmon).

\newpage

**Table 1.** Breakdown of relevant quantities by river stratum (area).

```{r Table, results = "asis"}

empty = rep(0, n.strata); names(empty) = strata
ints = table(dat$stratum); empty[names(ints)] = ints; ints = as.numeric(empty); ints.sum = sum(ints)
set.nets = flight.dat$set.nets; set.nets.sum = sum(set.nets)
max.count = apply(flight.dat.raw[flight.dat.raw$gear == "drift",strata], 2, max); max.count.sum = sum(max.count)

chin = unname(strat.tot["mean","chinook",]); chin.sum = as.numeric(gsub(x = tot["mean","chinook"], pattern = ",", replacement = ""))
chum = unname(strat.tot["mean","chum",]); chum.sum = as.numeric(gsub(x = tot["mean","chum"], pattern = ",", replacement = ""))
sock = unname(strat.tot["mean","sockeye",]); sock.sum = as.numeric(gsub(x = tot["mean","sockeye"], pattern = ",", replacement = ""))

tab = data.frame(ints, max.count, set.nets, boat.trips, chin, chum, sock)
sums = c(ints.sum, max.count.sum, set.nets.sum, n.trips, chin.sum, chum.sum, sock.sum)
# tab = data.frame(ints, max.count, boat.trips, chin, chum, sock)
# sums = c(ints.sum, max.count.sum, n.trips, chin.sum, chum.sum, sock.sum)

tab = rbind(tab, sums)

tab = apply(tab, 2, prettyNum, big.mark = ",", scientific = F)

rw.names = c("Tunt-Johnson", "Johnson-Napaskiak", "Napaskiak-Akaichak", "Akiachak-Akiak", "Total")
cl.names = c("Stratum", "Interviews", "Max Drift Count", "Set Net Count", "Est. Drift Trips", "Chinook Harvest", "Chum Harvest", "Sockeye Harvest")

tab = cbind(rw.names, tab)
rownames(tab) = NULL
colnames(tab) = cl.names
# c("30%", rep("10%", ncol(tab) - 1))
pandoc.table(tab, split.cells = c(3, rep(1, ncol(tab) - 1)), emphasize.strong.rows = nrow(tab), justify = c("right", rep("center", ncol(tab) - 1)))
# pandoc.table(tab, style = "simple", emphasize.strong.rows = nrow(tab), justify = c("right", rep("center", ncol(tab) - 1)))
```

**Table 2.** Specific quantities for the decision framework used by the USFWS and KRITFC. _Salmon/boat_ is total salmon harvest per drift boat and _Ratio_ is the chum/sockeye:Chinook salmon ratio. Quantities were calculated using the harvest estimates for each species and the number of estimated number of boat trips, _not_ the raw interview values. 

```{r Table 2, results = "asis"}

tab = rbind(cpb.below, cpb.above, ratio.below, ratio.above)

tab = as.data.frame(tab)

area = c("Below Johnson R.", "Above Johnson R.", "Below Johnson R.", "Above Johnson R.")
quant = c("Salmon/Boat", "Salmon/Boat", "Ratio", "Ratio")

tab = cbind(area, quant, tab)

rownames(tab) = NULL
colnames(tab) = c("Area", "Quantity", "Mean", "Lower 95%", "Upper 95%")

# pandoc.table(tab, justify = c("left", "left", rep("center", 3)), split.cells = c("40%", "30%", "10%", "10%", "10%"))
pandoc.table(tab, style = "simple", justify = c("left", "left", rep("center", 3)))
```

**Figure 1.** Distribution of relevant quantities from all collected drift boat interviews, excluding those conducted by USFWS law enforcement officers. BBH = Bethel boat harbor, CBM = community-based monitoring, FC = Bethel area fish camps. 

```{r Generate Histograms, fig.width = 7.5, fig.height = 5.3}

# remove LE data
drift.dat = drift.dat[drift.dat$source != "LE",]

sources = drift.dat$source

n.bins = 10

# total salmon catch
tot.catch = rowSums(drift.dat[,c("chinook", "chum", "sockeye")])
all.tot.catch = round(mean(tot.catch, na.rm = T),2)
bbh.tot.catch = round(mean(tot.catch[sources == "BBH"], na.rm = T),2)
cbm.tot.catch = round(mean(tot.catch[sources == "CBM"], na.rm = T),2)
fc.tot.catch = round(mean(tot.catch[sources == "FC"], na.rm = T),2)
tot.catch.breaks = seq(min(tot.catch, na.rm = T), max(tot.catch, na.rm = T), length = n.bins)

# chinook catch
chin.catch = drift.dat$chinook
all.chin.catch = round(mean(chin.catch, na.rm = T),2)
bbh.chin.catch = round(mean(chin.catch[sources == "BBH"], na.rm = T),2)
cbm.chin.catch = round(mean(chin.catch[sources == "CBM"], na.rm = T),2)
fc.chin.catch = round(mean(chin.catch[sources == "FC"], na.rm = T),2)
chin.catch.breaks = seq(min(chin.catch, na.rm = T), max(chin.catch, na.rm = T), length = n.bins)

# chum catch
chum.sock.catch = drift.dat$chum + drift.dat$sockeye
all.chum.sock.catch = round(mean(chum.sock.catch, na.rm = T),2)
bbh.chum.sock.catch = round(mean(chum.sock.catch[sources == "BBH"], na.rm = T),2)
cbm.chum.sock.catch = round(mean(chum.sock.catch[sources == "CBM"], na.rm = T),2)
fc.chum.sock.catch = round(mean(chum.sock.catch[sources == "FC"], na.rm = T),2)
chum.sock.catch.breaks = seq(min(chum.sock.catch, na.rm = T), max(chum.sock.catch, na.rm = T), length = n.bins)

# soak hours
soak.hrs = drift.dat$soak.hrs
all.soak.hrs = round(mean(soak.hrs, na.rm = T),2)
bbh.soak.hrs = round(mean(soak.hrs[sources == "BBH"], na.rm = T),2)
cbm.soak.hrs = round(mean(soak.hrs[sources == "CBM"], na.rm = T),2)
fc.soak.hrs = round(mean(soak.hrs[sources == "FC"], na.rm = T),2)
soak.hrs.breaks = seq(min(soak.hrs, na.rm = T), max(soak.hrs, na.rm = T), length = n.bins)

# trip start time
duration = drift.dat$trip.end - drift.dat$trip.start
all.duration = round(mean(duration, na.rm = T),2)
bbh.duration = round(mean(duration[sources == "BBH"], na.rm = T),2)
cbm.duration = round(mean(duration[sources == "CBM"], na.rm = T),2)
fc.duration = round(mean(duration[sources == "FC"], na.rm = T),2)
duration.breaks = seq(min(duration, na.rm = T), max(duration, na.rm = T), length = n.bins)

# ratio
ratio = (drift.dat$chum + drift.dat$sockeye)/drift.dat$chinook
ratio[is.na(ratio) | ratio == "Inf"] = NA
all.ratio = round(mean(ratio, na.rm = T),2)
bbh.ratio = round(mean(ratio[sources == "BBH"], na.rm = T),2)
cbm.ratio = round(mean(ratio[sources == "CBM"], na.rm = T),2)
fc.ratio = round(mean(ratio[sources == "FC"], na.rm = T),2)
ratio.breaks = seq(min(ratio, na.rm = T), max(ratio, na.rm = T), length = n.bins)

# plotting region
par(mfrow = c(2,3), mar = c(2,1.8,2,1.8), oma = c(0,2,0,0), xaxs = "i", yaxs = "i")

# histograms
# total salmon catch
ymax = max(hist(tot.catch, breaks = tot.catch.breaks, plot = F)$counts) * 1.2
hist(tot.catch, breaks = tot.catch.breaks, col = "grey90", xlab = "", ylab = "", main = "Total Salmon Catch/Trip", las = 1, ylim = c(0, ymax)); usr = par("usr")
add.hist.legend(all.mean = all.tot.catch, bbh.mean = bbh.tot.catch, fc.mean = fc.tot.catch , cbm.mean = cbm.tot.catch)
segments(usr[1], usr[3], usr[2], usr[3], xpd = T)

# chinook catch
ymax = max(hist(chin.catch, breaks = chin.catch.breaks, plot = F)$counts) * 1.2
hist(chin.catch, breaks = chin.catch.breaks, col = "grey90", xlab = "", ylab = "", main = "Chinook Salmon Catch/Trip", las = 1, ylim = c(0, ymax)); usr = par("usr")
add.hist.legend(all.mean = all.chin.catch, bbh.mean = bbh.chin.catch, fc.mean = fc.chin.catch, cbm.mean = cbm.chin.catch)
segments(usr[1], usr[3], usr[2], usr[3], xpd = T)

# chum+sockeye catch
ymax = max(hist(chum.sock.catch, breaks = chum.sock.catch.breaks, plot = F)$counts) * 1.2
hist(chum.sock.catch, breaks = chum.sock.catch.breaks, col = "grey90", xlab = "", ylab = "", main = "Chum/Sockeye Salmon Catch/Trip", las = 1, ylim = c(0, ymax)); usr = par("usr")
add.hist.legend(all.mean = all.chum.sock.catch, bbh.mean = bbh.chum.sock.catch, fc.mean = fc.chum.sock.catch, cbm.mean = cbm.chum.sock.catch)
segments(usr[1], usr[3], usr[2], usr[3], xpd = T)

# trip duration
ymax = max(hist(duration, breaks = duration.breaks, plot = F)$counts) * 1.2
hist(duration, breaks = duration.breaks, col = "grey90", xlab = "", ylab = "", main = "Trip Duration (Hours)", las = 1, ylim = c(0, ymax)); usr = par("usr")
add.hist.legend(all.mean = all.duration, bbh.mean = bbh.duration, fc.mean = fc.duration, cbm.mean = cbm.duration)
segments(usr[1], usr[3], usr[2], usr[3], xpd = T)

# soak time
ymax = max(hist(soak.hrs, breaks = soak.hrs.breaks, plot = F)$counts) * 1.2
hist(soak.hrs, breaks = soak.hrs.breaks, col = "grey90", xlab = "", ylab = "", main = "Soak Hours/Trip", las = 1, ylim = c(0, ymax)); usr = par("usr")
add.hist.legend(all.mean = all.soak.hrs, bbh.mean = bbh.soak.hrs, fc.mean = fc.soak.hrs, cbm.mean = cbm.soak.hrs)
segments(usr[1], usr[3], usr[2], usr[3], xpd = T)

# species ratio
ymax = max(hist(ratio, breaks = ratio.breaks, plot = F)$counts) * 1.2
hist(ratio, breaks = ratio.breaks, col = "grey90", xlab = "", ylab = "", main = "Species Ratio", las = 1, ylim = c(0, ymax)); usr = par("usr")
add.hist.legend(all.mean = all.ratio, bbh.mean = bbh.ratio, fc.mean = fc.ratio, cbm.mean = cbm.ratio)
segments(usr[1], usr[3], usr[2], usr[3], xpd = T)

mtext(side = 2, outer = T, "Frequency", line = 0.5)

```

`r if (doA) "\\newpage"`

`r if (doA) "# Appendix A: Bethel Boat Harbor Interview Information Detailed Summaries"`

`r if (doA) "_Information is for drift nets only_"`

`r if (doA) "**Column Meanings**"`

`r if (doA) "* **Area**: The area of the river the trip occurred in"`
`r if (doA) "* **N**: The number of interviews with fishing reported in each area"`
`r if (doA) "* **Min**: the minimum value among all interviews conducted in each area"`
`r if (doA) "* **25%**: the value that 25% of the interview values fell below in each area"`
`r if (doA) "* **Mean**: the mean value among all interviews conducted in each area"`
`r if (doA) "* **75%**: the value that 75% of the interview values fell below in each area"`
`r if (doA) "* **Max**: the maximum value among all interviews conducted in each area"`

```{r Appendix A Session Setup, eval = doA}
# clear the workspace
rm(list = setdiff(ls(), c("doA", "doB", "includeProgress", "dFile")))

# Data directory
data_dir = "C:/Users/bstaton/Documents/StatonWork/2_Harvest Estimates/6_12_18_TA"

# read functions into workspace
message = F
source("C:/Users/bstaton/Documents/StatonWork/2_Harvest Estimates/Functions_Source.R")
```

```{r Appendix A Dates to Keep, eval = doA}
# the dates to keep in the rest of the analysis.
# THIS IS KEY, OTHERWISE YOU COULD USE THE WRONG CATCH AND EFFORT DATA!!!
keep.dates = c("6/12")
```

```{r Appendix A Step 1: Prepare All Data, eval = doA}

# the columns in the right order for all interview data sets
cols = c("source", "date", "stratum", "trip.start", "trip.end", "soak.hrs", "length", 
         "gear", "mesh", "chinook", "chum", "sockeye", "chinook.cpe", "chum.cpe", "sockeye.cpe")

# read in raw interview files
raw.dat = read.csv(paste(data_dir, file_name("BBH", dFile), sep = "/"), stringsAsFactors = F)

# PREPARE BETHEL BOAT HARBOR DATA
dat = bbh.prep(raw.dat, includeWhiteFish = F)

# remove questionable entries for now
dat = dat[-which(dat$mesh > 8),]

# KEEP ONLY THE DATES OF INTEREST
dat = dat[dat$date %in% keep.dates,]

n.drift = nrow(dat[dat$gear == "drift",])
n.set = nrow(dat[dat$gear == "set",])

dat = dat[dat$gear == "drift",]
dat = dat[dat$stratum != "D1",]
```

```{r Summary Function, eval = doA}
summ = function(x, rnd = 1, includeN = F) {
  
  if (includeN) {
    out = round(c(N = length(x), Min = min(x, na.rm = T), quantile(x, 0.25, na.rm = T), Mean = mean(x, na.rm = T),  quantile(x, 0.75, na.rm = T), Max = max(x, na.rm = T)), rnd)
  }
  
  if (!includeN) {
    out = round(c(Min = min(x, na.rm = T), quantile(x, 0.25, na.rm = T), Mean = mean(x, na.rm = T), quantile(x, 0.75, na.rm = T), Max = max(x, na.rm = T)), rnd)
  }
  
  out
}

```

`r if (doA) "**Table A1.** Summary of catch rates for Chinook salmon by area (units are catch per 150 feet of net soaked for 1 hour)."`

```{r Table A1, results = "asis", eval = doA}

strata = sort(unique(dat$stratum))
n.strata = length(strata)

tab = matrix(unlist(tapply(dat$chinook.cpe * 150, dat$stratum, summ, includeN = T)), nrow = n.strata, ncol = 6, byrow = T)
all = summ(dat$chinook.cpe * 150, includeN = T)
tab = rbind(tab, all)

tab = as.data.frame(tab)

strata = c(strata, "All")

nmes = c(A = "Tunt. - Johnson R.", B = "Johnson R. - Napaskiak", C = "Napaskiak - Akiachak", D1 = "Akiachak - Akiak", All = "All")

tab = cbind(Area = nmes[strata], tab)
rownames(tab) = NULL
pandoc.table(tab, style = "simple", justify = c("left", rep("center", ncol(tab) - 1)), emphasize.strong.cols = 1, emphasize.strong.rows = nrow(tab))

```

`r if (doA) "**Table A2.** Summary of catch per trip for Chinook salmon by area."`

```{r Table A2, results = "asis", eval = doA}

strata = sort(unique(dat$stratum))
n.strata = length(strata)

tab = matrix(unlist(tapply(dat$chinook, dat$stratum, summ, includeN = T, rnd = 0)), nrow = n.strata, ncol = 6, byrow = T)
all = summ(dat$chinook, includeN = T, rnd = 0)
tab = rbind(tab, all)

tab = as.data.frame(tab)

strata = c(strata, "All")

nmes = c(A = "Tunt. - Johnson R.", B = "Johnson R. - Napaskiak", C = "Napaskiak - Akiachak", D1 = "Akiachak - Akiak", All = "All")

tab = cbind(Area = nmes[strata], tab)
rownames(tab) = NULL
pandoc.table(tab, style = "simple", justify = c("left", rep("center", ncol(tab) - 1)), emphasize.strong.cols = 1, emphasize.strong.rows = nrow(tab))

```

`r if (doA) "**Table A3.** Summary of catch rates for chum/sockeye salmon by area (units are catch per 150 feet of net soaked for 1 hour)."`

```{r Table A3, results = "asis", eval = doA}

strata = sort(unique(dat$stratum))
n.strata = length(strata)

tab = matrix(unlist(tapply((dat$chum.cpe + dat$sockeye.cpe) * 150, dat$stratum, summ, includeN = T, rnd = 1)), nrow = n.strata, ncol = 6, byrow = T)
all = summ((dat$chum.cpe + dat$sockeye.cpe) * 150, includeN = T, rnd = 1)
tab = rbind(tab, all)

tab = as.data.frame(tab)

strata = c(strata, "All")

nmes = c(A = "Tunt. - Johnson R.", B = "Johnson R. - Napaskiak", C = "Napaskiak - Akiachak", D1 = "Akiachak - Akiak", All = "All")

tab = cbind(Area = nmes[strata], tab)
rownames(tab) = NULL
pandoc.table(tab, style = "simple", justify = c("left", rep("center", ncol(tab) - 1)), emphasize.strong.cols = 1, emphasize.strong.rows = nrow(tab))


```

`r if (doA) "**Table A4.** Summary of catch per trip for chum/sockeye salmon by area."`

```{r Table A4, results = "asis", eval = doA}

strata = sort(unique(dat$stratum))
n.strata = length(strata)

tab = matrix(unlist(tapply((dat$chum + dat$sockeye), dat$stratum, summ, includeN = T, rnd = 0)), nrow = n.strata, ncol = 6, byrow = T)
all = summ((dat$chum + dat$sockeye), includeN = T, rnd = 0)
tab = rbind(tab, all)

tab = as.data.frame(tab)

strata = c(strata, "All")

nmes = c(A = "Tunt. - Johnson R.", B = "Johnson R. - Napaskiak", C = "Napaskiak - Akiachak", D1 = "Akiachak - Akiak", All = "All")

tab = cbind(Area = nmes[strata], tab)
rownames(tab) = NULL
pandoc.table(tab, style = "simple", justify = c("left", rep("center", ncol(tab) - 1)), emphasize.strong.cols = 1, emphasize.strong.rows = nrow(tab))


```

`r if (doA) "**Table A5.** Summary of the percent of salmon catches that were Chinook salmon by area."`

```{r Table A5, results = "asis", eval = doA}
# `r if (doA) "**Table A5.** Summary of species ratios (chum/sockeye:Chinook salmon) by area."`
# strata = sort(unique(dat$stratum))
# n.strata = length(strata)
# 
# dat$ratio = (dat$chum + dat$sockeye)/dat$chinook
# dat$ratio[is.na(dat$ratio) | dat$ratio == "Inf"] = NA
# 
# tab = matrix(unlist(tapply(dat$ratio, dat$stratum, summ, includeN = T, rnd = 1)), nrow = n.strata, ncol = 6, byrow = T)
# all = summ(dat$ratio, includeN = T, rnd = 1)
# tab = rbind(tab, all)
# 
# tab = as.data.frame(tab)
# 
# strata = c(strata, "All")
# 
# nmes = c(A = "Tunt. - Johnson R.", B = "Johnson R. - Napaskiak", C = "Napaskiak - Akiachak", D1 = "Akiachak - Akiak", All = "All")
# 
# tab = cbind(Area = nmes[strata], tab)
# rownames(tab) = NULL
# pandoc.table(tab, style = "simple", justify = c("left", rep("center", ncol(tab) - 1)), emphasize.strong.cols = 1, emphasize.strong.rows = nrow(tab))

strata = sort(unique(dat$stratum))
n.strata = length(strata)

dat$perc.chin = dat$chinook/(dat$chum + dat$sockeye + dat$chinook) * 100

tab = matrix(unlist(tapply(dat$perc.chin, dat$stratum, summ, includeN = T, rnd = 0)), nrow = n.strata, ncol = 6, byrow = T)
all = summ(dat$perc.chin, includeN = T, rnd = 0)
tab = rbind(tab, all)

tab[,c("Min", "25%", "Mean", "75%", "Max")] = matrix(paste(tab[,c("Min", "25%", "Mean", "75%", "Max")], "%", sep = ""), nrow(tab), ncol(tab)-1)

tab[tab[,"N"] == 1, c("Min", "25%", "75%", "Max")] = ""

tab = as.data.frame(tab)

strata = c(strata, "All")

nmes = c(A = "Tunt. - Johnson R.", B = "Johnson R. - Napaskiak", C = "Napaskiak - Akiachak", D1 = "Akiachak - Akiak", All = "All")

tab = cbind(Area = nmes[strata], tab)
rownames(tab) = NULL
pandoc.table(tab, style = "simple", justify = c("left", rep("center", ncol(tab) - 1)), emphasize.strong.cols = 1, emphasize.strong.rows = nrow(tab))
```

`r if (doA) "\\newpage"`

`r if (doA) "**Table A6.** Summary of trip start time by area."`

```{r Table A7, results = "asis", eval = doA}

strata = sort(unique(dat$stratum))
n.strata = length(strata)

tab = matrix(military.to.12hr(unlist(tapply(dat$trip.start, dat$stratum, summ, includeN = F, rnd = 5))), nrow = n.strata, ncol = 5, byrow = T)
all = military.to.12hr(summ(dat$trip.start, includeN = F, rnd = 5))
tab = rbind(tab, all)

tab = as.data.frame(tab)

strata = c(strata, "All")

nmes = c(A = "Tunt. - Johnson R.", B = "Johnson R. - Napaskiak", C = "Napaskiak - Akiachak", D1 = "Akiachak - Akiak", All = "All")

tab = cbind(Area = nmes[strata], tab)
rownames(tab) = NULL
pandoc.table(tab, style = "simple", justify = c("left", rep("center", ncol(tab) - 1)), emphasize.strong.cols = 1, emphasize.strong.rows = nrow(tab))
```

`r if (doA) "**Table A7.** Summary of trip end time by area."`

```{r Table A8, results = "asis", eval = doA}

strata = sort(unique(dat$stratum))
n.strata = length(strata)

tab = matrix(military.to.12hr(unlist(tapply(dat$trip.end, dat$stratum, summ, includeN = F, rnd = 5))), nrow = n.strata, ncol = 5, byrow = T)
all = military.to.12hr(summ(dat$trip.end, includeN = F, rnd = 5))
tab = rbind(tab, all)

tab = as.data.frame(tab)

strata = c(strata, "All")

nmes = c(A = "Tunt. - Johnson R.", B = "Johnson R. - Napaskiak", C = "Napaskiak - Akiachak", D1 = "Akiachak - Akiak", All = "All")
tab = cbind(Area = nmes[strata], tab)
rownames(tab) = NULL
pandoc.table(tab, style = "simple", justify = c("left", rep("center", ncol(tab) - 1)), emphasize.strong.cols = 1, emphasize.strong.rows = nrow(tab))
             # split.cells = c(15, rep(1, ncol(tab) - 1)))
```

`r if (doB) "\\newpage"`

`r if (doB) "# Appendix B: Village-Specific Interview Information Detailed Summaries"`

`r if (doB) "_Information is for drift nets only; data from Kasigluk were collected by ADF&G Division of Subsistence, all other data were collected by KRITFC/BSFA community-based harvest monitors_"`

`r if (doB) "**Column Meanings**"`

`r if (doB) "* **Village**: The village the interview occurred in"`
`r if (doB) "* **N**: The number of interviews conducted in each village"`
`r if (doB) "* **Min**: the minimum value among all interviews conducted in each village"`
`r if (doB) "* **25%**: the value that 25% of the interview values fell below in each village"`
`r if (doB) "* **Mean**: the mean value among all interviews conducted in each village"`
`r if (doB) "* **75%**: the value that 75% of the interview values fell below in each village"`
`r if (doB) "* **Max**: the maximum value among all interviews conducted in each village"`

```{r Appendix B Session Setup, eval = doB}
library(pander)

# clear the workspace
rm(list = setdiff(ls(), c("doB", "includeProgress", "dFile")))

# Data directory
data_dir = "C:/Users/bstaton/Documents/StatonWork/2_Harvest Estimates/6_12_18_TA"

# read functions into workspace
message = F
source("C:/Users/bstaton/Documents/StatonWork/2_Harvest Estimates/Functions_Source.R")
```

```{r Appendix B Dates to Keep, eval = doB}
# the dates to keep in the rest of the analysis.
# THIS IS KEY, OTHERWISE YOU COULD USE THE WRONG CATCH AND EFFORT DATA!!!
keep.dates = c("6/12")
```

```{r Appendix B Step 1: Prepare All Data, eval = doB}

# the columns in the right order for all interview data sets
cols = c("source", "date", "stratum", "trip.start", "trip.end", "soak.hrs", "length", 
         "gear", "mesh", "chinook", "chum", "sockeye", "chinook.cpe", "chum.cpe", "sockeye.cpe")

# read in raw interview files
raw.dat = read.csv(paste(data_dir, file_name("CBM", dFile), sep = "/"), stringsAsFactors = F)
dat = cbm.prep(dat = raw.dat, includeVillage = T)

# PREPARE ADFG DATA FROM KASIGLUK
adfg.raw.dat = read.csv(paste(data_dir, file_name("ADFG", dFile), sep = "/"), stringsAsFactors = F)
adfg.dat = cbm.prep(dat = adfg.raw.dat, includeVillage = T)
adfg.goals = adfg.dat$goals
adfg.dat = adfg.dat$catch.effort
adfg.dat$source = "ADFG"

goals = dat$goals
dat = dat$catch.effort
dat = rbind(dat, adfg.dat)

# KEEP ONLY THE DATES OF INTEREST
dat = dat[dat$date %in% keep.dates,]

n.drift = nrow(dat[dat$gear == "drift",])
n.set = nrow(dat[dat$gear == "set",])

dat = dat[dat$gear == "drift",]
```

```{r Appendix B Summary Function, eval = doB}
summ = function(x, rnd = 1, includeN = F) {
  
  if (includeN) {
    out = round(c(N = length(x), Min = min(x, na.rm = T), quantile(x, 0.25, na.rm = T), Mean = mean(x, na.rm = T),  quantile(x, 0.75, na.rm = T), Max = max(x, na.rm = T)), rnd)
  }
  
  if (!includeN) {
    out = round(c(Min = min(x, na.rm = T), quantile(x, 0.25, na.rm = T), Mean = mean(x, na.rm = T), quantile(x, 0.75, na.rm = T), Max = max(x, na.rm = T)), rnd)
  }
  
  out
}

military.to.12hr = function(times) {
  hours = floor(times)
  decimals = times - hours
  mins = round((decimals) * 60)
  mins = as.character(mins)
  mins[mins == "0"] = "00"
  mins = ifelse(nchar(mins) == 1, paste("0", mins, sep = ""), mins)
  am.pm = ifelse(hours >= 12, "pm", "am")
  hours = ifelse(am.pm == "pm" & hours != 12, hours - 12, hours)
  times = paste(paste(hours, mins, sep = ":"),am.pm, sep = "")

  times = ifelse(hours == 24, "12:00am", times)
  times
}

```

`r if (doB) "**Table B1.** Summary of catch rates for Chinook salmon by village (units are catch per 150 feet of net soaked for 1 hour)."`

```{r Chinook CPE table, results = "asis", eval = doB}

strata = sort(unique(dat$village))
n.strata = length(strata)

tab = matrix(unlist(tapply(dat$chinook.cpe * 150, dat$village, summ, includeN = T)), nrow = n.strata, ncol = 6, byrow = T)
all = summ(dat$chinook.cpe * 150, includeN = T)
tab = rbind(tab, all)

tab = as.data.frame(tab)

rownames(tab) = c(strata, "All")

tab = cbind(Village = rownames(tab), tab)
rownames(tab) = NULL

pandoc.table(tab, style = "simple", justify = c("left", rep("center", ncol(tab) - 1)), emphasize.strong.cols = 1, emphasize.strong.rows = nrow(tab))

```

`r if (doB) "**Table B2.** Summary of catch per trip for Chinook salmon by village."`

```{r Chinook Catch table, results = "asis", eval = doB}

strata = sort(unique(dat$village))
n.strata = length(strata)

tab = matrix(unlist(tapply(dat$chinook, dat$village, summ, includeN = T, rnd = 0)), nrow = n.strata, ncol = 6, byrow = T)
all = summ(dat$chinook.cpe, includeN = T, rnd = 0)
tab = rbind(tab, all)

tab = as.data.frame(tab)

rownames(tab) = c(strata, "All")

tab = cbind(Village = rownames(tab), tab)
rownames(tab) = NULL

pandoc.table(tab, style = "simple", justify = c("left", rep("center", ncol(tab) - 1)), emphasize.strong.cols = 1, emphasize.strong.rows = nrow(tab))

```

`r if (doB) "**Table B3.** Summary of catch rates for chum/sockeye salmon by village (units are catch per 150 feet of net soaked for 1 hour)."`

```{r Chum + Sock CPE table, results = "asis", eval = doB}

strata = sort(unique(dat$village))
n.strata = length(strata)

tab = matrix(unlist(tapply((dat$chum.cpe + dat$sockeye.cpe) * 150, dat$village, summ, includeN = T, rnd = 0)), nrow = n.strata, ncol = 6, byrow = T)
all = summ((dat$chum.cpe + dat$sockeye.cpe) * 150, includeN = T, rnd = 0)
tab = rbind(tab, all)

tab = as.data.frame(tab)

rownames(tab) = c(strata, "All")

tab = cbind(Village = rownames(tab), tab)
rownames(tab) = NULL

pandoc.table(tab, style = "simple", justify = c("left", rep("center", ncol(tab) - 1)), emphasize.strong.cols = 1, emphasize.strong.rows = nrow(tab))

```

`r if (doB) "\\newpage"`

`r if (doB) "**Table B4.** Summary of catch per trip for chum/sockeye salmon by village."`

```{r Chum + Sock Catch table, results = "asis", eval = doB}
strata = sort(unique(dat$village))
n.strata = length(strata)

tab = matrix(unlist(tapply((dat$chum + dat$sockeye), dat$village, summ, includeN = T, rnd = 0)), nrow = n.strata, ncol = 6, byrow = T)
all = summ((dat$chum + dat$sockeye), includeN = T, rnd = 0)
tab = rbind(tab, all)

tab = as.data.frame(tab)

rownames(tab) = c(strata, "All")

tab = cbind(Village = rownames(tab), tab)
rownames(tab) = NULL

pandoc.table(tab, style = "simple", justify = c("left", rep("center", ncol(tab) - 1)), emphasize.strong.cols = 1, emphasize.strong.rows = nrow(tab))

```

`r if (doB) "**Table B5.** Summary of the percent of salmon catches that were Chinook salmon by village."`

```{r Ratio table, results = "asis", eval = doB}

# dat$ratio = (dat$chum + dat$sockeye)/dat$chinook
# dat$ratio[is.na(dat$ratio) | dat$ratio == "Inf"] = NA
# 
# strata = sort(unique(dat$village))
# n.strata = length(strata)
# 
# tab = matrix(unlist(tapply(dat$ratio, dat$village, summ, includeN = T, rnd = 1)), nrow = n.strata, ncol = 6, byrow = T)
# all = summ(dat$ratio, includeN = T, rnd = 1)
# tab = rbind(tab, all)
# 
# tab = as.data.frame(tab)
# 
# rownames(tab) = c(strata, "All")
# 
# tab = cbind(Village = rownames(tab), tab)
# rownames(tab) = NULL
# 
# pandoc.table(tab, style = "simple", justify = c("left", rep("center", ncol(tab) - 1)), emphasize.strong.cols = 1, emphasize.strong.rows = nrow(tab))

strata = sort(unique(dat$village))
n.strata = length(strata)

dat$perc.chin = dat$chinook/(dat$chinook + dat$chum + dat$sockeye) * 100

tab = matrix(unlist(tapply(dat$perc.chin, dat$village, summ, includeN = T, rnd = 0)), nrow = n.strata, ncol = 6, byrow = T)
all = summ(dat$perc.chin, includeN = T, rnd = 0)
tab = rbind(tab, all)

tab[,c("Min", "25%", "Mean", "75%", "Max")] = matrix(paste(tab[,c("Min", "25%", "Mean", "75%", "Max")], "%", sep = ""), nrow(tab), ncol(tab)-1)

tab = as.data.frame(tab)

rownames(tab) = c(strata, "All")

tab = cbind(Village = rownames(tab), tab)
rownames(tab) = NULL

pandoc.table(tab, style = "simple", justify = c("left", rep("center", ncol(tab) - 1)), emphasize.strong.cols = 1, emphasize.strong.rows = nrow(tab))

```

`r if (doB) "**Table B6.** Summary of trip start time by village."`

```{r Trip Start time table, results = "asis", eval = doB}

strata = sort(unique(dat$village))
n.strata = length(strata)

tab = matrix(military.to.12hr(unlist(tapply(dat$trip.start, dat$village, summ, includeN = F, rnd = 5))), nrow = n.strata, ncol = 5, byrow = T)
all = military.to.12hr(summ(dat$trip.start, includeN = F, rnd = 5))
tab = rbind(tab, all)

tab = as.data.frame(tab)

rownames(tab) = c(strata, "All")

tab = cbind(Village = rownames(tab), tab)
rownames(tab) = NULL

pandoc.table(tab, style = "simple", justify = c("left", rep("center", ncol(tab) - 1)), emphasize.strong.cols = 1, emphasize.strong.rows = nrow(tab))

```

`r if (doB) "**Table B7.** Summary of trip end time by village."`

```{r Trip End time table, results = "asis", eval = doB}
strata = sort(unique(dat$village))
n.strata = length(strata)

tab = matrix(military.to.12hr(unlist(tapply(dat$trip.end, dat$village, summ, includeN = F, rnd = 5))), nrow = n.strata, ncol = 5, byrow = T)
all = military.to.12hr(summ(dat$trip.end, includeN = F, rnd = 5))
tab = rbind(tab, all)

tab = as.data.frame(tab)

rownames(tab) = c(strata, "All")

tab = cbind(Village = rownames(tab), tab)
rownames(tab) = NULL

pandoc.table(tab, style = "simple", justify = c("left", rep("center", ncol(tab) - 1)), emphasize.strong.cols = 1, emphasize.strong.rows = nrow(tab))

```

`r if (includeProgress) "\\newpage"`

`r if (includeProgress) "**Figure B1.** Visual of the interviewed fishers' progress at meeting harvest goals for each three salmon species of interest. The height of the point/grey area is interpretted as the percent of interviewed fishers that have met at least the category on the horizonal axis. More grey on the left indicates fishers are close to meeting needs, less grey on left indicates fishers are far from meeting needs."`

```{r, fig.height=3, fig.width = 9, eval = includeProgress}
goal.plot(goals = goals)
```

