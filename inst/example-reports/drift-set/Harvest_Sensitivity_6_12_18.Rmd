---
title: "Harvest Sensitivity"
subtitle: "6/12/2018 Opportunity"
output:
  pdf_document:
    toc: true
linkcolor: "blue"
geometry: margin=0.5in
---

```{r Markdown Setup, include = F}
knitr::opts_chunk$set(echo = FALSE, fig.align = "center", warning = F, message = F, results = "hide", fig.height = 6, fig.width = 9)
```

```{r Session Setup}
library(pander)

# clear the workspace
rm(list = ls(all = T))

# the directory where all data files are located
data_dir = "C:/Users/bstaton/Documents/StatonWork/2_Harvest Estimates/6_12_18_TA/"

# read functions into workspace
message = F
# source("C:/Users/bas0041/Dropbox/PhD Project/USFWS Work/2017/Inseason Harvest Estimates/Functions_Source.R")
source("C:/Users/bstaton/Documents/StatonWork/2_Harvest Estimates/Functions_Source.R")

# set global table option to never break table on two rows
panderOptions(o = "table.split.table", value = Inf) 

# number of bootstrapped samples
n.boot = 1000

# set the random seed to always get same estimates.
set.seed(2)

# decide if you want to include the various appendicies
doA = T
doB = T
includeProgress = F  # decide if you want to include the progress plot. MUST BE FALSE IF !doB

# the date in file names
dFile = "6_12_18"

```

```{r Dates to Keep}
# the dates to keep in the rest of the analysis.
# THIS IS KEY, OTHERWISE YOU COULD USE THE WRONG CATCH AND EFFORT DATA!!!
keep.dates = c("6/12")
```

```{r Step 1: Prepare All Data}
# the columns in the right order for all interview data sets
cols = c("source", "date", "stratum", "trip.start", "trip.end", "soak.hrs", "length", 
         "gear", "mesh", "chinook", "chum", "sockeye", "chinook.cpe", "chum.cpe", "sockeye.cpe")

# read in raw interview files
cbm.raw.dat = read.csv(paste(data_dir, file_name("CBM", dFile), sep = "/"), stringsAsFactors = F)
bbh.raw.dat = read.csv(paste(data_dir, file_name("BBH", dFile), sep = "/"), stringsAsFactors = F)
adfg.raw.dat = read.csv(paste(data_dir, file_name("ADFG", dFile), sep = "/"), stringsAsFactors = F)
fc.raw.dat = read.csv(paste(data_dir, file_name("FC", dFile), sep = "/"), stringsAsFactors = F)
le.raw.dat = read.csv(paste(data_dir, file_name("LE", dFile), sep = "/"), stringsAsFactors = F)

# read in raw flight data
flight.dat.raw = read.csv(paste(data_dir, file_name("Flight_counts", dFile), sep = "/"), stringsAsFactors = F)

# PREPARE BETHEL BOAT HARBOR DATA
bbh.dat = bbh.prep(bbh.raw.dat)

# remove questionable entries for now
bbh.dat = bbh.dat[-which(bbh.dat$length %in% c(25, 35) | bbh.dat$mesh > 8),]

# PREPARE COMMUNITY BASED MONITORING DATA
cbm.dat = cbm.prep(dat = cbm.raw.dat)
cbm.goals = cbm.dat$goals
cbm.dat = cbm.dat$catch.effort

# PREPARE ADFG DATA FROM KASIGLUK
adfg.dat = cbm.prep(dat = adfg.raw.dat)
adfg.goals = adfg.dat$goals
adfg.dat = adfg.dat$catch.effort
adfg.dat$source = "ADFG"

# PREPARE BETHEL AREA FISH CAMP DATA
fc.dat = fc.prep(dat = fc.raw.dat)

# PREPARE LAW ENFORCEMENT INTERVIEWS
le.dat = LE.prep(le.raw.dat)

# COMBINE ALL DATASETS INTO ONE
dat = rbind(bbh.dat, cbm.dat, adfg.dat, le.dat, fc.dat)

# KEEP ONLY THE DATES OF INTEREST
dat = dat[dat$date %in% keep.dates,]

# SEPARATE INTERVIEW DATA BY GEAR TYPES
drift.dat = dat[dat$gear == "drift",]
set.dat = dat[dat$gear == "set",]

# PREPARE FLIGHT DATA
flight.dat = flight.prep(dat = flight.dat.raw)
```

```{r Step 2: Generate Total Drift Effort Estimates}
trip.ests = estimate.trips(trips = drift.dat, 
                         f1.times = flight.dat$f1.times, num.f1 = flight.dat$drift.tot[1],
                         f2.times = flight.dat$f2.times, num.f2 = flight.dat$drift.tot[2],
                         f3.times = flight.dat$f3.times, num.f3 = flight.dat$drift.tot[3])

n.trips = unname(trip.ests["total.b"])

boat.trips = round(flight.dat$drift.p * n.trips)
set.nets = flight.dat$set.nets
```

\newpage

# Sensitivity to the Removal of Data Sources

## All Data

```{r}
# strata
strata = names(boat.trips)
n.strata = length(strata)

# pooling of information: which data should be used in each stratum?
# table(drift.dat$stratum)

use.A = c("A")
use.B = c("B")
use.C = c("C")
use.D1 = c("D1")

# containers: [iterations,species,strata]
rand.strat.drift = rand.strat.set = array(NA, dim = c(n.boot, 3, n.strata))
dimnames(rand.strat.drift) = dimnames(rand.strat.set) = list(1:n.boot, c("chinook", "chum", "sockeye"), strata)

keep.sources = c("CBM", "LE", "BBH", "FC", "ADFG")

# produce estimates with randomized data
for (i in 1:n.boot) {
  rand.strat.drift[i,,"A"] = estimate.harvest(dat = randomize.data(drift.dat[drift.dat$stratum %in% use.A & drift.dat$source %in% keep.sources,]), n.trips = unname(boat.trips["A"]))
  rand.strat.drift[i,,"B"] = estimate.harvest(dat = randomize.data(drift.dat[drift.dat$stratum %in% use.B & drift.dat$source %in% keep.sources,]), n.trips = unname(boat.trips["B"]))
  rand.strat.drift[i,,"C"] = estimate.harvest(dat = randomize.data(drift.dat[drift.dat$stratum %in% use.C & drift.dat$source %in% keep.sources,]), n.trips = unname(boat.trips["C"]))
  rand.strat.drift[i,,"D1"] = estimate.harvest(dat = randomize.data(drift.dat[drift.dat$stratum %in% use.D1 & drift.dat$source %in% keep.sources,]), n.trips = unname(boat.trips["D1"]))
  
  rand.strat.set[i,,"A"] = estimate.harvest(dat = randomize.data(set.dat), n.trips = unname(set.nets["A"]))
  rand.strat.set[i,,"B"] = estimate.harvest(dat = randomize.data(set.dat), n.trips = unname(set.nets["B"]))
  rand.strat.set[i,,"C"] = estimate.harvest(dat = randomize.data(set.dat), n.trips = unname(set.nets["C"]))
  rand.strat.set[i,,"D1"] = estimate.harvest(dat = randomize.data(set.dat), n.trips = unname(set.nets["D1"]))
  # rand.strat.set[i,,"A"] = 0
  # rand.strat.set[i,,"B"] = 0
  # rand.strat.set[i,,"C"] = 0
  # rand.strat.set[i,,"D1"] = 0
}

# estimate.harvest(dat = set.dat, n.trips = unname(set.nets["A"]))
# estimate.harvest(dat = set.dat, n.trips = unname(set.nets["B"]))
# estimate.harvest(dat = set.dat, n.trips = unname(set.nets["C"]))
# estimate.harvest(dat = set.dat, n.trips = unname(set.nets["D1"]))
# estimate.harvest(dat = drift.dat[drift.dat$stratum %in% use.A,], n.trips = unname(boat.trips["A"]))
# estimate.harvest(dat = drift.dat[drift.dat$stratum %in% use.B,], n.trips = unname(boat.trips["B"]))
# estimate.harvest(dat = drift.dat[drift.dat$stratum %in% use.C,], n.trips = unname(boat.trips["C"]))
# estimate.harvest(dat = drift.dat[drift.dat$stratum %in% use.D1,], n.trips = unname(boat.trips["D1"]))
```

```{r}

# NOTATION
  # if includes 'rand', these are estimates for each random data set
  # if includes 'strat', these are stratified by geographic stratum
  # if includes 'tot', these are summed across strata but not necessarily across gears
  # if includes 'drift', these are drift harvests only
  # if includes 'set', these are set harvest only
  # all objects (except 'all.salmon' ones) have species as the second dimension!!

# randomized harvest by stratum across both gears
rand.strat = rand.strat.drift + rand.strat.set

# randomized total harvest by drift boats across strata
rand.tot.drift = apply(rand.strat.drift, 2, rowSums)

# randomized total harvest by set netsacross strata
rand.tot.set = apply(rand.strat.set, 2, rowSums)

# randomized total harvest across gears across strata
rand.tot = rand.tot.drift + rand.tot.set

# randomized all salmon harvest
rand.all.salmon = rowSums(rand.tot)

# summarized total harvest by gear
tot.drift = apply(rand.tot.drift, 2, rand.summ)
tot.set = apply(rand.tot.set, 2, rand.summ)

# summarized total harvest across gears
tot = apply(rand.tot, 2, rand.summ, pretty = T)
# apply(rand.tot, 2, function(x) sd(x)/mean(x))

# summarized total salmon harvest
all.salmon = rand.summ(rand.all.salmon, pretty = T)

# summaries by stratum
strat.drift = strat.set = strat.tot = array(NA, dim = c(3, 3, 4))
strat.all.salmon.drift = matrix(NA, 3,4); rownames(strat.all.salmon.drift) = rownames(tot); colnames(strat.all.salmon.drift) = strata
strat.all.salmon.set = matrix(NA, 3,4); rownames(strat.all.salmon.set) = rownames(tot); colnames(strat.all.salmon.set) = strata
strat.all.salmon.tot = matrix(NA, 3,4); rownames(strat.all.salmon.tot) = rownames(tot); colnames(strat.all.salmon.tot) = strata
dimnames(strat.drift) = dimnames(strat.set) = dimnames(strat.tot) = list(rownames(tot), colnames(tot), strata)
for (s in 1:n.strata) {
  strat.drift[,,strata[s]] = apply(rand.strat.drift[,,strata[s]], 2, rand.summ)
  strat.set[,,strata[s]] = apply(rand.strat.set[,,strata[s]], 2, rand.summ)
  strat.tot[,,strata[s]] = apply(rand.strat[,,strata[s]], 2, rand.summ)
  
  strat.all.salmon.drift[,s] = rand.summ(rowSums(rand.strat.drift[,,strata[s]]))
  strat.all.salmon.set[,s] = rand.summ(rowSums(rand.strat.set[,,strata[s]]))
  strat.all.salmon.tot[,s] = rand.summ(rowSums(rand.strat.drift[,,strata[s]]) + rowSums(rand.strat.set[,,strata[s]]))
}

# rand.summ(rowSums(apply(rand.strat.drift,3,rowSums)))
# rand.summ(rowSums(apply(rand.strat.set,3,rowSums)))
# rand.summ(rowSums(apply(rand.strat.drift + rand.strat.set,3,rowSums)))

# calculate total chinook salmon harvest below BTF
# rand.chin.btf = rand.strat[,"chinook","A"] + rand.strat[,"chinook","B"] + rand.strat[,"chinook","C"] * 0.5
# mean(rand.chin.btf); sd(rand.chin.btf)

# calculate the total salmon harvest by set nets
rand.all.salmon.set = rowSums(rand.tot.set)
all.salmon.set = rand.summ(rand.all.salmon.set)

# calculate the proportion of set net harvest by species
rand.p.spp.set = t(apply(rand.tot.set, 1, function(x) x/sum(x)))
p.spp.set = apply(rand.p.spp.set, 2, rand.summ, rnd = 2)
p.spp.set = p.spp.set["mean",] * 100

tot.all = tot
cv.all = apply(rand.tot, 2, function(x) sd(x, na.rm = T)/mean(x, na.rm = T))
```

* An estimated total of **`r report(all.salmon)`** salmon were harvested.
    * An estimated total of **`r report(tot[,"chinook"])`** Chinook salmon were harvested.
    * An estimated total of **`r report(tot[,"chum"])`** chum salmon were harvested.
    * An estimated total of **`r report(tot[,"sockeye"])`** sockeye salmon were harvested.
* Harvest by set nets accounted for an estimated **`r report(all.salmon.set)`** total salmon (**`r p.spp.set["chinook"]`%** Chinook salmon, **`r p.spp.set["chum"]`%** chum salmon, and **`r p.spp.set["sockeye"]`%** sockeye salmon).

## No BBH Data

```{r}
# strata
strata = names(boat.trips)
n.strata = length(strata)

# pooling of information: which data should be used in each stratum?
# t(table(drift.dat$stratum, drift.dat$source))

use.A = c("A")
use.B = c("B")
use.C = c("C")
use.D1 = c("D1")

# containers: [iterations,species,strata]
rand.strat.drift = rand.strat.set = array(NA, dim = c(n.boot, 3, n.strata))
dimnames(rand.strat.drift) = dimnames(rand.strat.set) = list(1:n.boot, c("chinook", "chum", "sockeye"), strata)

keep.sources = c("CBM", "LE", "FC", "ADFG")

# produce estimates with randomized data
for (i in 1:n.boot) {
  rand.strat.drift[i,,"A"] = estimate.harvest(dat = randomize.data(drift.dat[drift.dat$stratum %in% use.A & drift.dat$source %in% keep.sources,]), n.trips = unname(boat.trips["A"]))
  rand.strat.drift[i,,"B"] = estimate.harvest(dat = randomize.data(drift.dat[drift.dat$stratum %in% use.B & drift.dat$source %in% keep.sources,]), n.trips = unname(boat.trips["B"]))
  rand.strat.drift[i,,"C"] = estimate.harvest(dat = randomize.data(drift.dat[drift.dat$stratum %in% use.C & drift.dat$source %in% keep.sources,]), n.trips = unname(boat.trips["C"]))
  rand.strat.drift[i,,"D1"] = estimate.harvest(dat = randomize.data(drift.dat[drift.dat$stratum %in% use.D1 & drift.dat$source %in% keep.sources,]), n.trips = unname(boat.trips["D1"]))
  
  rand.strat.set[i,,"A"] = estimate.harvest(dat = randomize.data(set.dat), n.trips = unname(set.nets["A"]))
  rand.strat.set[i,,"B"] = estimate.harvest(dat = randomize.data(set.dat), n.trips = unname(set.nets["B"]))
  rand.strat.set[i,,"C"] = estimate.harvest(dat = randomize.data(set.dat), n.trips = unname(set.nets["C"]))
  rand.strat.set[i,,"D1"] = estimate.harvest(dat = randomize.data(set.dat), n.trips = unname(set.nets["D1"]))
  # rand.strat.set[i,,"A"] = 0
  # rand.strat.set[i,,"B"] = 0
  # rand.strat.set[i,,"C"] = 0
  # rand.strat.set[i,,"D1"] = 0
}

# estimate.harvest(dat = set.dat, n.trips = unname(set.nets["A"]))
# estimate.harvest(dat = set.dat, n.trips = unname(set.nets["B"]))
# estimate.harvest(dat = set.dat, n.trips = unname(set.nets["C"]))
# estimate.harvest(dat = set.dat, n.trips = unname(set.nets["D1"]))
# estimate.harvest(dat = drift.dat[drift.dat$stratum %in% use.A,], n.trips = unname(boat.trips["A"]))
# estimate.harvest(dat = drift.dat[drift.dat$stratum %in% use.B,], n.trips = unname(boat.trips["B"]))
# estimate.harvest(dat = drift.dat[drift.dat$stratum %in% use.C,], n.trips = unname(boat.trips["C"]))
# estimate.harvest(dat = drift.dat[drift.dat$stratum %in% use.D1,], n.trips = unname(boat.trips["D1"]))
```

```{r}

# NOTATION
  # if includes 'rand', these are estimates for each random data set
  # if includes 'strat', these are stratified by geographic stratum
  # if includes 'tot', these are summed across strata but not necessarily across gears
  # if includes 'drift', these are drift harvests only
  # if includes 'set', these are set harvest only
  # all objects (except 'all.salmon' ones) have species as the second dimension!!

# randomized harvest by stratum across both gears
rand.strat = rand.strat.drift + rand.strat.set

# randomized total harvest by drift boats across strata
rand.tot.drift = apply(rand.strat.drift, 2, rowSums)

# randomized total harvest by set netsacross strata
rand.tot.set = apply(rand.strat.set, 2, rowSums)

# randomized total harvest across gears across strata
rand.tot = rand.tot.drift + rand.tot.set

# randomized all salmon harvest
rand.all.salmon = rowSums(rand.tot)

# summarized total harvest by gear
tot.drift = apply(rand.tot.drift, 2, rand.summ)
tot.set = apply(rand.tot.set, 2, rand.summ)

# summarized total harvest across gears
tot = apply(rand.tot, 2, rand.summ, pretty = T)
# apply(rand.tot, 2, function(x) sd(x)/mean(x))

# summarized total salmon harvest
all.salmon = rand.summ(rand.all.salmon, pretty = T)

# summaries by stratum
strat.drift = strat.set = strat.tot = array(NA, dim = c(3, 3, 4))
strat.all.salmon.drift = matrix(NA, 3,4); rownames(strat.all.salmon.drift) = rownames(tot); colnames(strat.all.salmon.drift) = strata
strat.all.salmon.set = matrix(NA, 3,4); rownames(strat.all.salmon.set) = rownames(tot); colnames(strat.all.salmon.set) = strata
strat.all.salmon.tot = matrix(NA, 3,4); rownames(strat.all.salmon.tot) = rownames(tot); colnames(strat.all.salmon.tot) = strata
dimnames(strat.drift) = dimnames(strat.set) = dimnames(strat.tot) = list(rownames(tot), colnames(tot), strata)
for (s in 1:n.strata) {
  strat.drift[,,strata[s]] = apply(rand.strat.drift[,,strata[s]], 2, rand.summ)
  strat.set[,,strata[s]] = apply(rand.strat.set[,,strata[s]], 2, rand.summ)
  strat.tot[,,strata[s]] = apply(rand.strat[,,strata[s]], 2, rand.summ)
  
  strat.all.salmon.drift[,s] = rand.summ(rowSums(rand.strat.drift[,,strata[s]]))
  strat.all.salmon.set[,s] = rand.summ(rowSums(rand.strat.set[,,strata[s]]))
  strat.all.salmon.tot[,s] = rand.summ(rowSums(rand.strat.drift[,,strata[s]]) + rowSums(rand.strat.set[,,strata[s]]))
}

# rand.summ(rowSums(apply(rand.strat.drift,3,rowSums)))
# rand.summ(rowSums(apply(rand.strat.set,3,rowSums)))
# rand.summ(rowSums(apply(rand.strat.drift + rand.strat.set,3,rowSums)))

# calculate total chinook salmon harvest below BTF
# rand.chin.btf = rand.strat[,"chinook","A"] + rand.strat[,"chinook","B"] + rand.strat[,"chinook","C"] * 0.5
# mean(rand.chin.btf); sd(rand.chin.btf)

# calculate the total salmon harvest by set nets
rand.all.salmon.set = rowSums(rand.tot.set)
all.salmon.set = rand.summ(rand.all.salmon.set)

# calculate the proportion of set net harvest by species
rand.p.spp.set = t(apply(rand.tot.set, 1, function(x) x/sum(x)))
p.spp.set = apply(rand.p.spp.set, 2, rand.summ, rnd = 2)
p.spp.set = p.spp.set["mean",] * 100

tot.bbh = tot
cv.bbh = apply(rand.tot, 2, function(x) sd(x, na.rm = T)/mean(x, na.rm = T))
```

* An estimated total of **`r report(all.salmon)`** salmon were harvested.
    * An estimated total of **`r report(tot[,"chinook"])`** Chinook salmon were harvested.
    * An estimated total of **`r report(tot[,"chum"])`** chum salmon were harvested.
    * An estimated total of **`r report(tot[,"sockeye"])`** sockeye salmon were harvested.
* Harvest by set nets accounted for an estimated **`r report(all.salmon.set)`** total salmon (**`r p.spp.set["chinook"]`%** Chinook salmon, **`r p.spp.set["chum"]`%** chum salmon, and **`r p.spp.set["sockeye"]`%** sockeye salmon).

## No CBM Data

```{r}
# strata
strata = names(boat.trips)
n.strata = length(strata)

# pooling of information: which data should be used in each stratum?
# table(drift.dat$stratum)

use.A = c("A")
use.B = c("B")
use.C = c("C")
use.D1 = c("D1")

# containers: [iterations,species,strata]
rand.strat.drift = rand.strat.set = array(NA, dim = c(n.boot, 3, n.strata))
dimnames(rand.strat.drift) = dimnames(rand.strat.set) = list(1:n.boot, c("chinook", "chum", "sockeye"), strata)

keep.sources = c("LE", "BBH", "FC", "ADFG")

# produce estimates with randomized data
for (i in 1:n.boot) {
  rand.strat.drift[i,,"A"] = estimate.harvest(dat = randomize.data(drift.dat[drift.dat$stratum %in% use.A & drift.dat$source %in% keep.sources,]), n.trips = unname(boat.trips["A"]))
  rand.strat.drift[i,,"B"] = estimate.harvest(dat = randomize.data(drift.dat[drift.dat$stratum %in% use.B & drift.dat$source %in% keep.sources,]), n.trips = unname(boat.trips["B"]))
  rand.strat.drift[i,,"C"] = estimate.harvest(dat = randomize.data(drift.dat[drift.dat$stratum %in% use.C & drift.dat$source %in% keep.sources,]), n.trips = unname(boat.trips["C"]))
  rand.strat.drift[i,,"D1"] = estimate.harvest(dat = randomize.data(drift.dat[drift.dat$stratum %in% use.D1 & drift.dat$source %in% keep.sources,]), n.trips = unname(boat.trips["D1"]))
  
  rand.strat.set[i,,"A"] = estimate.harvest(dat = randomize.data(set.dat), n.trips = unname(set.nets["A"]))
  rand.strat.set[i,,"B"] = estimate.harvest(dat = randomize.data(set.dat), n.trips = unname(set.nets["B"]))
  rand.strat.set[i,,"C"] = estimate.harvest(dat = randomize.data(set.dat), n.trips = unname(set.nets["C"]))
  rand.strat.set[i,,"D1"] = estimate.harvest(dat = randomize.data(set.dat), n.trips = unname(set.nets["D1"]))
  # rand.strat.set[i,,"A"] = 0
  # rand.strat.set[i,,"B"] = 0
  # rand.strat.set[i,,"C"] = 0
  # rand.strat.set[i,,"D1"] = 0
}

# estimate.harvest(dat = set.dat, n.trips = unname(set.nets["A"]))
# estimate.harvest(dat = set.dat, n.trips = unname(set.nets["B"]))
# estimate.harvest(dat = set.dat, n.trips = unname(set.nets["C"]))
# estimate.harvest(dat = set.dat, n.trips = unname(set.nets["D1"]))
# estimate.harvest(dat = drift.dat[drift.dat$stratum %in% use.A,], n.trips = unname(boat.trips["A"]))
# estimate.harvest(dat = drift.dat[drift.dat$stratum %in% use.B,], n.trips = unname(boat.trips["B"]))
# estimate.harvest(dat = drift.dat[drift.dat$stratum %in% use.C,], n.trips = unname(boat.trips["C"]))
# estimate.harvest(dat = drift.dat[drift.dat$stratum %in% use.D1,], n.trips = unname(boat.trips["D1"]))
```

```{r}

# NOTATION
  # if includes 'rand', these are estimates for each random data set
  # if includes 'strat', these are stratified by geographic stratum
  # if includes 'tot', these are summed across strata but not necessarily across gears
  # if includes 'drift', these are drift harvests only
  # if includes 'set', these are set harvest only
  # all objects (except 'all.salmon' ones) have species as the second dimension!!

# randomized harvest by stratum across both gears
rand.strat = rand.strat.drift + rand.strat.set

# randomized total harvest by drift boats across strata
rand.tot.drift = apply(rand.strat.drift, 2, rowSums)

# randomized total harvest by set netsacross strata
rand.tot.set = apply(rand.strat.set, 2, rowSums)

# randomized total harvest across gears across strata
rand.tot = rand.tot.drift + rand.tot.set

# randomized all salmon harvest
rand.all.salmon = rowSums(rand.tot)

# summarized total harvest by gear
tot.drift = apply(rand.tot.drift, 2, rand.summ)
tot.set = apply(rand.tot.set, 2, rand.summ)

# summarized total harvest across gears
tot = apply(rand.tot, 2, rand.summ, pretty = T)
# apply(rand.tot, 2, function(x) sd(x)/mean(x))

# summarized total salmon harvest
all.salmon = rand.summ(rand.all.salmon, pretty = T)

# summaries by stratum
strat.drift = strat.set = strat.tot = array(NA, dim = c(3, 3, 4))
strat.all.salmon.drift = matrix(NA, 3,4); rownames(strat.all.salmon.drift) = rownames(tot); colnames(strat.all.salmon.drift) = strata
strat.all.salmon.set = matrix(NA, 3,4); rownames(strat.all.salmon.set) = rownames(tot); colnames(strat.all.salmon.set) = strata
strat.all.salmon.tot = matrix(NA, 3,4); rownames(strat.all.salmon.tot) = rownames(tot); colnames(strat.all.salmon.tot) = strata
dimnames(strat.drift) = dimnames(strat.set) = dimnames(strat.tot) = list(rownames(tot), colnames(tot), strata)
for (s in 1:n.strata) {
  strat.drift[,,strata[s]] = apply(rand.strat.drift[,,strata[s]], 2, rand.summ)
  strat.set[,,strata[s]] = apply(rand.strat.set[,,strata[s]], 2, rand.summ)
  strat.tot[,,strata[s]] = apply(rand.strat[,,strata[s]], 2, rand.summ)
  
  strat.all.salmon.drift[,s] = rand.summ(rowSums(rand.strat.drift[,,strata[s]]))
  strat.all.salmon.set[,s] = rand.summ(rowSums(rand.strat.set[,,strata[s]]))
  strat.all.salmon.tot[,s] = rand.summ(rowSums(rand.strat.drift[,,strata[s]]) + rowSums(rand.strat.set[,,strata[s]]))
}

# rand.summ(rowSums(apply(rand.strat.drift,3,rowSums)))
# rand.summ(rowSums(apply(rand.strat.set,3,rowSums)))
# rand.summ(rowSums(apply(rand.strat.drift + rand.strat.set,3,rowSums)))

# calculate total chinook salmon harvest below BTF
# rand.chin.btf = rand.strat[,"chinook","A"] + rand.strat[,"chinook","B"] + rand.strat[,"chinook","C"] * 0.5
# mean(rand.chin.btf); sd(rand.chin.btf)

# calculate the total salmon harvest by set nets
rand.all.salmon.set = rowSums(rand.tot.set)
all.salmon.set = rand.summ(rand.all.salmon.set)

# calculate the proportion of set net harvest by species
rand.p.spp.set = t(apply(rand.tot.set, 1, function(x) x/sum(x)))
p.spp.set = apply(rand.p.spp.set, 2, rand.summ, rnd = 2)
p.spp.set = p.spp.set["mean",] * 100

tot.cbm = tot
cv.cbm = apply(rand.tot, 2, function(x) sd(x, na.rm = T)/mean(x, na.rm = T))

```

* An estimated total of **`r report(all.salmon)`** salmon were harvested.
    * An estimated total of **`r report(tot[,"chinook"])`** Chinook salmon were harvested.
    * An estimated total of **`r report(tot[,"chum"])`** chum salmon were harvested.
    * An estimated total of **`r report(tot[,"sockeye"])`** sockeye salmon were harvested.
* Harvest by set nets accounted for an estimated **`r report(all.salmon.set)`** total salmon (**`r p.spp.set["chinook"]`%** Chinook salmon, **`r p.spp.set["chum"]`%** chum salmon, and **`r p.spp.set["sockeye"]`%** sockeye salmon).

## No ADF&G Data

```{r}
# strata
strata = names(boat.trips)
n.strata = length(strata)

# pooling of information: which data should be used in each stratum?
# table(drift.dat$stratum)

use.A = c("A")
use.B = c("B")
use.C = c("C")
use.D1 = c("D1")

# containers: [iterations,species,strata]
rand.strat.drift = rand.strat.set = array(NA, dim = c(n.boot, 3, n.strata))
dimnames(rand.strat.drift) = dimnames(rand.strat.set) = list(1:n.boot, c("chinook", "chum", "sockeye"), strata)

keep.sources = c("CBM", "LE", "BBH", "FC")

# produce estimates with randomized data
for (i in 1:n.boot) {
  rand.strat.drift[i,,"A"] = estimate.harvest(dat = randomize.data(drift.dat[drift.dat$stratum %in% use.A & drift.dat$source %in% keep.sources,]), n.trips = unname(boat.trips["A"]))
  rand.strat.drift[i,,"B"] = estimate.harvest(dat = randomize.data(drift.dat[drift.dat$stratum %in% use.B & drift.dat$source %in% keep.sources,]), n.trips = unname(boat.trips["B"]))
  rand.strat.drift[i,,"C"] = estimate.harvest(dat = randomize.data(drift.dat[drift.dat$stratum %in% use.C & drift.dat$source %in% keep.sources,]), n.trips = unname(boat.trips["C"]))
  rand.strat.drift[i,,"D1"] = estimate.harvest(dat = randomize.data(drift.dat[drift.dat$stratum %in% use.D1 & drift.dat$source %in% keep.sources,]), n.trips = unname(boat.trips["D1"]))
  
  rand.strat.set[i,,"A"] = estimate.harvest(dat = randomize.data(set.dat), n.trips = unname(set.nets["A"]))
  rand.strat.set[i,,"B"] = estimate.harvest(dat = randomize.data(set.dat), n.trips = unname(set.nets["B"]))
  rand.strat.set[i,,"C"] = estimate.harvest(dat = randomize.data(set.dat), n.trips = unname(set.nets["C"]))
  rand.strat.set[i,,"D1"] = estimate.harvest(dat = randomize.data(set.dat), n.trips = unname(set.nets["D1"]))
  # rand.strat.set[i,,"A"] = 0
  # rand.strat.set[i,,"B"] = 0
  # rand.strat.set[i,,"C"] = 0
  # rand.strat.set[i,,"D1"] = 0
}

# estimate.harvest(dat = set.dat, n.trips = unname(set.nets["A"]))
# estimate.harvest(dat = set.dat, n.trips = unname(set.nets["B"]))
# estimate.harvest(dat = set.dat, n.trips = unname(set.nets["C"]))
# estimate.harvest(dat = set.dat, n.trips = unname(set.nets["D1"]))
# estimate.harvest(dat = drift.dat[drift.dat$stratum %in% use.A,], n.trips = unname(boat.trips["A"]))
# estimate.harvest(dat = drift.dat[drift.dat$stratum %in% use.B,], n.trips = unname(boat.trips["B"]))
# estimate.harvest(dat = drift.dat[drift.dat$stratum %in% use.C,], n.trips = unname(boat.trips["C"]))
# estimate.harvest(dat = drift.dat[drift.dat$stratum %in% use.D1,], n.trips = unname(boat.trips["D1"]))
```

```{r}

# NOTATION
  # if includes 'rand', these are estimates for each random data set
  # if includes 'strat', these are stratified by geographic stratum
  # if includes 'tot', these are summed across strata but not necessarily across gears
  # if includes 'drift', these are drift harvests only
  # if includes 'set', these are set harvest only
  # all objects (except 'all.salmon' ones) have species as the second dimension!!

# randomized harvest by stratum across both gears
rand.strat = rand.strat.drift + rand.strat.set

# randomized total harvest by drift boats across strata
rand.tot.drift = apply(rand.strat.drift, 2, rowSums)

# randomized total harvest by set netsacross strata
rand.tot.set = apply(rand.strat.set, 2, rowSums)

# randomized total harvest across gears across strata
rand.tot = rand.tot.drift + rand.tot.set

# randomized all salmon harvest
rand.all.salmon = rowSums(rand.tot)

# summarized total harvest by gear
tot.drift = apply(rand.tot.drift, 2, rand.summ)
tot.set = apply(rand.tot.set, 2, rand.summ)

# summarized total harvest across gears
tot = apply(rand.tot, 2, rand.summ, pretty = T)
# apply(rand.tot, 2, function(x) sd(x)/mean(x))

# summarized total salmon harvest
all.salmon = rand.summ(rand.all.salmon, pretty = T)

# summaries by stratum
strat.drift = strat.set = strat.tot = array(NA, dim = c(3, 3, 4))
strat.all.salmon.drift = matrix(NA, 3,4); rownames(strat.all.salmon.drift) = rownames(tot); colnames(strat.all.salmon.drift) = strata
strat.all.salmon.set = matrix(NA, 3,4); rownames(strat.all.salmon.set) = rownames(tot); colnames(strat.all.salmon.set) = strata
strat.all.salmon.tot = matrix(NA, 3,4); rownames(strat.all.salmon.tot) = rownames(tot); colnames(strat.all.salmon.tot) = strata
dimnames(strat.drift) = dimnames(strat.set) = dimnames(strat.tot) = list(rownames(tot), colnames(tot), strata)
for (s in 1:n.strata) {
  strat.drift[,,strata[s]] = apply(rand.strat.drift[,,strata[s]], 2, rand.summ)
  strat.set[,,strata[s]] = apply(rand.strat.set[,,strata[s]], 2, rand.summ)
  strat.tot[,,strata[s]] = apply(rand.strat[,,strata[s]], 2, rand.summ)
  
  strat.all.salmon.drift[,s] = rand.summ(rowSums(rand.strat.drift[,,strata[s]]))
  strat.all.salmon.set[,s] = rand.summ(rowSums(rand.strat.set[,,strata[s]]))
  strat.all.salmon.tot[,s] = rand.summ(rowSums(rand.strat.drift[,,strata[s]]) + rowSums(rand.strat.set[,,strata[s]]))
}

# rand.summ(rowSums(apply(rand.strat.drift,3,rowSums)))
# rand.summ(rowSums(apply(rand.strat.set,3,rowSums)))
# rand.summ(rowSums(apply(rand.strat.drift + rand.strat.set,3,rowSums)))

# calculate total chinook salmon harvest below BTF
# rand.chin.btf = rand.strat[,"chinook","A"] + rand.strat[,"chinook","B"] + rand.strat[,"chinook","C"] * 0.5
# mean(rand.chin.btf); sd(rand.chin.btf)

# calculate the total salmon harvest by set nets
rand.all.salmon.set = rowSums(rand.tot.set)
all.salmon.set = rand.summ(rand.all.salmon.set)

# calculate the proportion of set net harvest by species
rand.p.spp.set = t(apply(rand.tot.set, 1, function(x) x/sum(x)))
p.spp.set = apply(rand.p.spp.set, 2, rand.summ, rnd = 2)
p.spp.set = p.spp.set["mean",] * 100

tot.adfg = tot
cv.adfg = apply(rand.tot, 2, function(x) sd(x, na.rm = T)/mean(x, na.rm = T))

```

* An estimated total of **`r report(all.salmon)`** salmon were harvested.
    * An estimated total of **`r report(tot[,"chinook"])`** Chinook salmon were harvested.
    * An estimated total of **`r report(tot[,"chum"])`** chum salmon were harvested.
    * An estimated total of **`r report(tot[,"sockeye"])`** sockeye salmon were harvested.
* Harvest by set nets accounted for an estimated **`r report(all.salmon.set)`** total salmon (**`r p.spp.set["chinook"]`%** Chinook salmon, **`r p.spp.set["chum"]`%** chum salmon, and **`r p.spp.set["sockeye"]`%** sockeye salmon).

## No FC Data

```{r}
# strata
strata = names(boat.trips)
n.strata = length(strata)

# pooling of information: which data should be used in each stratum?
# table(drift.dat$stratum)

use.A = c("A")
use.B = c("B")
use.C = c("C")
use.D1 = c("D1")

# containers: [iterations,species,strata]
rand.strat.drift = rand.strat.set = array(NA, dim = c(n.boot, 3, n.strata))
dimnames(rand.strat.drift) = dimnames(rand.strat.set) = list(1:n.boot, c("chinook", "chum", "sockeye"), strata)

keep.sources = c("CBM", "LE", "BBH", "ADFG")

# produce estimates with randomized data
for (i in 1:n.boot) {
  rand.strat.drift[i,,"A"] = estimate.harvest(dat = randomize.data(drift.dat[drift.dat$stratum %in% use.A & drift.dat$source %in% keep.sources,]), n.trips = unname(boat.trips["A"]))
  rand.strat.drift[i,,"B"] = estimate.harvest(dat = randomize.data(drift.dat[drift.dat$stratum %in% use.B & drift.dat$source %in% keep.sources,]), n.trips = unname(boat.trips["B"]))
  rand.strat.drift[i,,"C"] = estimate.harvest(dat = randomize.data(drift.dat[drift.dat$stratum %in% use.C & drift.dat$source %in% keep.sources,]), n.trips = unname(boat.trips["C"]))
  rand.strat.drift[i,,"D1"] = estimate.harvest(dat = randomize.data(drift.dat[drift.dat$stratum %in% use.D1 & drift.dat$source %in% keep.sources,]), n.trips = unname(boat.trips["D1"]))
  
  rand.strat.set[i,,"A"] = estimate.harvest(dat = randomize.data(set.dat), n.trips = unname(set.nets["A"]))
  rand.strat.set[i,,"B"] = estimate.harvest(dat = randomize.data(set.dat), n.trips = unname(set.nets["B"]))
  rand.strat.set[i,,"C"] = estimate.harvest(dat = randomize.data(set.dat), n.trips = unname(set.nets["C"]))
  rand.strat.set[i,,"D1"] = estimate.harvest(dat = randomize.data(set.dat), n.trips = unname(set.nets["D1"]))
  # rand.strat.set[i,,"A"] = 0
  # rand.strat.set[i,,"B"] = 0
  # rand.strat.set[i,,"C"] = 0
  # rand.strat.set[i,,"D1"] = 0
}

# estimate.harvest(dat = set.dat, n.trips = unname(set.nets["A"]))
# estimate.harvest(dat = set.dat, n.trips = unname(set.nets["B"]))
# estimate.harvest(dat = set.dat, n.trips = unname(set.nets["C"]))
# estimate.harvest(dat = set.dat, n.trips = unname(set.nets["D1"]))
# estimate.harvest(dat = drift.dat[drift.dat$stratum %in% use.A,], n.trips = unname(boat.trips["A"]))
# estimate.harvest(dat = drift.dat[drift.dat$stratum %in% use.B,], n.trips = unname(boat.trips["B"]))
# estimate.harvest(dat = drift.dat[drift.dat$stratum %in% use.C,], n.trips = unname(boat.trips["C"]))
# estimate.harvest(dat = drift.dat[drift.dat$stratum %in% use.D1,], n.trips = unname(boat.trips["D1"]))
```

```{r}

# NOTATION
  # if includes 'rand', these are estimates for each random data set
  # if includes 'strat', these are stratified by geographic stratum
  # if includes 'tot', these are summed across strata but not necessarily across gears
  # if includes 'drift', these are drift harvests only
  # if includes 'set', these are set harvest only
  # all objects (except 'all.salmon' ones) have species as the second dimension!!

# randomized harvest by stratum across both gears
rand.strat = rand.strat.drift + rand.strat.set

# randomized total harvest by drift boats across strata
rand.tot.drift = apply(rand.strat.drift, 2, rowSums)

# randomized total harvest by set netsacross strata
rand.tot.set = apply(rand.strat.set, 2, rowSums)

# randomized total harvest across gears across strata
rand.tot = rand.tot.drift + rand.tot.set

# randomized all salmon harvest
rand.all.salmon = rowSums(rand.tot)

# summarized total harvest by gear
tot.drift = apply(rand.tot.drift, 2, rand.summ)
tot.set = apply(rand.tot.set, 2, rand.summ)

# summarized total harvest across gears
tot = apply(rand.tot, 2, rand.summ, pretty = T)
# apply(rand.tot, 2, function(x) sd(x)/mean(x))

# summarized total salmon harvest
all.salmon = rand.summ(rand.all.salmon, pretty = T)

# summaries by stratum
strat.drift = strat.set = strat.tot = array(NA, dim = c(3, 3, 4))
strat.all.salmon.drift = matrix(NA, 3,4); rownames(strat.all.salmon.drift) = rownames(tot); colnames(strat.all.salmon.drift) = strata
strat.all.salmon.set = matrix(NA, 3,4); rownames(strat.all.salmon.set) = rownames(tot); colnames(strat.all.salmon.set) = strata
strat.all.salmon.tot = matrix(NA, 3,4); rownames(strat.all.salmon.tot) = rownames(tot); colnames(strat.all.salmon.tot) = strata
dimnames(strat.drift) = dimnames(strat.set) = dimnames(strat.tot) = list(rownames(tot), colnames(tot), strata)
for (s in 1:n.strata) {
  strat.drift[,,strata[s]] = apply(rand.strat.drift[,,strata[s]], 2, rand.summ)
  strat.set[,,strata[s]] = apply(rand.strat.set[,,strata[s]], 2, rand.summ)
  strat.tot[,,strata[s]] = apply(rand.strat[,,strata[s]], 2, rand.summ)
  
  strat.all.salmon.drift[,s] = rand.summ(rowSums(rand.strat.drift[,,strata[s]]))
  strat.all.salmon.set[,s] = rand.summ(rowSums(rand.strat.set[,,strata[s]]))
  strat.all.salmon.tot[,s] = rand.summ(rowSums(rand.strat.drift[,,strata[s]]) + rowSums(rand.strat.set[,,strata[s]]))
}

# rand.summ(rowSums(apply(rand.strat.drift,3,rowSums)))
# rand.summ(rowSums(apply(rand.strat.set,3,rowSums)))
# rand.summ(rowSums(apply(rand.strat.drift + rand.strat.set,3,rowSums)))

# calculate total chinook salmon harvest below BTF
# rand.chin.btf = rand.strat[,"chinook","A"] + rand.strat[,"chinook","B"] + rand.strat[,"chinook","C"] * 0.5
# mean(rand.chin.btf); sd(rand.chin.btf)

# calculate the total salmon harvest by set nets
rand.all.salmon.set = rowSums(rand.tot.set)
all.salmon.set = rand.summ(rand.all.salmon.set)

# calculate the proportion of set net harvest by species
rand.p.spp.set = t(apply(rand.tot.set, 1, function(x) x/sum(x)))
p.spp.set = apply(rand.p.spp.set, 2, rand.summ, rnd = 2)
p.spp.set = p.spp.set["mean",] * 100

tot.fc = tot
cv.fc = apply(rand.tot, 2, function(x) sd(x, na.rm = T)/mean(x, na.rm = T))

```

* An estimated total of **`r report(all.salmon)`** salmon were harvested.
    * An estimated total of **`r report(tot[,"chinook"])`** Chinook salmon were harvested.
    * An estimated total of **`r report(tot[,"chum"])`** chum salmon were harvested.
    * An estimated total of **`r report(tot[,"sockeye"])`** sockeye salmon were harvested.
* Harvest by set nets accounted for an estimated **`r report(all.salmon.set)`** total salmon (**`r p.spp.set["chinook"]`%** Chinook salmon, **`r p.spp.set["chum"]`%** chum salmon, and **`r p.spp.set["sockeye"]`%** sockeye salmon).

## No LE Data

```{r}
# strata
strata = names(boat.trips)
n.strata = length(strata)

# pooling of information: which data should be used in each stratum?
# table(drift.dat$stratum)

use.A = c("A")
use.B = c("B")
use.C = c("C")
use.D1 = c("D1")

# containers: [iterations,species,strata]
rand.strat.drift = rand.strat.set = array(NA, dim = c(n.boot, 3, n.strata))
dimnames(rand.strat.drift) = dimnames(rand.strat.set) = list(1:n.boot, c("chinook", "chum", "sockeye"), strata)

keep.sources = c("CBM", "ADFG", "BBH", "FC")

# produce estimates with randomized data
for (i in 1:n.boot) {
  rand.strat.drift[i,,"A"] = estimate.harvest(dat = randomize.data(drift.dat[drift.dat$stratum %in% use.A & drift.dat$source %in% keep.sources,]), n.trips = unname(boat.trips["A"]))
  rand.strat.drift[i,,"B"] = estimate.harvest(dat = randomize.data(drift.dat[drift.dat$stratum %in% use.B & drift.dat$source %in% keep.sources,]), n.trips = unname(boat.trips["B"]))
  rand.strat.drift[i,,"C"] = estimate.harvest(dat = randomize.data(drift.dat[drift.dat$stratum %in% use.C & drift.dat$source %in% keep.sources,]), n.trips = unname(boat.trips["C"]))
  rand.strat.drift[i,,"D1"] = estimate.harvest(dat = randomize.data(drift.dat[drift.dat$stratum %in% use.D1 & drift.dat$source %in% keep.sources,]), n.trips = unname(boat.trips["D1"]))
  
  rand.strat.set[i,,"A"] = estimate.harvest(dat = randomize.data(set.dat), n.trips = unname(set.nets["A"]))
  rand.strat.set[i,,"B"] = estimate.harvest(dat = randomize.data(set.dat), n.trips = unname(set.nets["B"]))
  rand.strat.set[i,,"C"] = estimate.harvest(dat = randomize.data(set.dat), n.trips = unname(set.nets["C"]))
  rand.strat.set[i,,"D1"] = estimate.harvest(dat = randomize.data(set.dat), n.trips = unname(set.nets["D1"]))
  # rand.strat.set[i,,"A"] = 0
  # rand.strat.set[i,,"B"] = 0
  # rand.strat.set[i,,"C"] = 0
  # rand.strat.set[i,,"D1"] = 0
}

# estimate.harvest(dat = set.dat, n.trips = unname(set.nets["A"]))
# estimate.harvest(dat = set.dat, n.trips = unname(set.nets["B"]))
# estimate.harvest(dat = set.dat, n.trips = unname(set.nets["C"]))
# estimate.harvest(dat = set.dat, n.trips = unname(set.nets["D1"]))
# estimate.harvest(dat = drift.dat[drift.dat$stratum %in% use.A,], n.trips = unname(boat.trips["A"]))
# estimate.harvest(dat = drift.dat[drift.dat$stratum %in% use.B,], n.trips = unname(boat.trips["B"]))
# estimate.harvest(dat = drift.dat[drift.dat$stratum %in% use.C,], n.trips = unname(boat.trips["C"]))
# estimate.harvest(dat = drift.dat[drift.dat$stratum %in% use.D1,], n.trips = unname(boat.trips["D1"]))
```

```{r}

# NOTATION
  # if includes 'rand', these are estimates for each random data set
  # if includes 'strat', these are stratified by geographic stratum
  # if includes 'tot', these are summed across strata but not necessarily across gears
  # if includes 'drift', these are drift harvests only
  # if includes 'set', these are set harvest only
  # all objects (except 'all.salmon' ones) have species as the second dimension!!

# randomized harvest by stratum across both gears
rand.strat = rand.strat.drift + rand.strat.set

# randomized total harvest by drift boats across strata
rand.tot.drift = apply(rand.strat.drift, 2, rowSums)

# randomized total harvest by set netsacross strata
rand.tot.set = apply(rand.strat.set, 2, rowSums)

# randomized total harvest across gears across strata
rand.tot = rand.tot.drift + rand.tot.set

# randomized all salmon harvest
rand.all.salmon = rowSums(rand.tot)

# summarized total harvest by gear
tot.drift = apply(rand.tot.drift, 2, rand.summ)
tot.set = apply(rand.tot.set, 2, rand.summ)

# summarized total harvest across gears
tot = apply(rand.tot, 2, rand.summ, pretty = T)
# apply(rand.tot, 2, function(x) sd(x)/mean(x))

# summarized total salmon harvest
all.salmon = rand.summ(rand.all.salmon, pretty = T)

# summaries by stratum
strat.drift = strat.set = strat.tot = array(NA, dim = c(3, 3, 4))
strat.all.salmon.drift = matrix(NA, 3,4); rownames(strat.all.salmon.drift) = rownames(tot); colnames(strat.all.salmon.drift) = strata
strat.all.salmon.set = matrix(NA, 3,4); rownames(strat.all.salmon.set) = rownames(tot); colnames(strat.all.salmon.set) = strata
strat.all.salmon.tot = matrix(NA, 3,4); rownames(strat.all.salmon.tot) = rownames(tot); colnames(strat.all.salmon.tot) = strata
dimnames(strat.drift) = dimnames(strat.set) = dimnames(strat.tot) = list(rownames(tot), colnames(tot), strata)
for (s in 1:n.strata) {
  strat.drift[,,strata[s]] = apply(rand.strat.drift[,,strata[s]], 2, rand.summ)
  strat.set[,,strata[s]] = apply(rand.strat.set[,,strata[s]], 2, rand.summ)
  strat.tot[,,strata[s]] = apply(rand.strat[,,strata[s]], 2, rand.summ)
  
  strat.all.salmon.drift[,s] = rand.summ(rowSums(rand.strat.drift[,,strata[s]]))
  strat.all.salmon.set[,s] = rand.summ(rowSums(rand.strat.set[,,strata[s]]))
  strat.all.salmon.tot[,s] = rand.summ(rowSums(rand.strat.drift[,,strata[s]]) + rowSums(rand.strat.set[,,strata[s]]))
}

# rand.summ(rowSums(apply(rand.strat.drift,3,rowSums)))
# rand.summ(rowSums(apply(rand.strat.set,3,rowSums)))
# rand.summ(rowSums(apply(rand.strat.drift + rand.strat.set,3,rowSums)))

# calculate total chinook salmon harvest below BTF
# rand.chin.btf = rand.strat[,"chinook","A"] + rand.strat[,"chinook","B"] + rand.strat[,"chinook","C"] * 0.5
# mean(rand.chin.btf); sd(rand.chin.btf)

# calculate the total salmon harvest by set nets
rand.all.salmon.set = rowSums(rand.tot.set)
all.salmon.set = rand.summ(rand.all.salmon.set)

# calculate the proportion of set net harvest by species
rand.p.spp.set = t(apply(rand.tot.set, 1, function(x) x/sum(x)))
p.spp.set = apply(rand.p.spp.set, 2, rand.summ, rnd = 2)
p.spp.set = p.spp.set["mean",] * 100

tot.le = tot
cv.le = apply(rand.tot, 2, function(x) sd(x, na.rm = T)/mean(x, na.rm = T))
```

* An estimated total of **`r report(all.salmon)`** salmon were harvested.
    * An estimated total of **`r report(tot[,"chinook"])`** Chinook salmon were harvested.
    * An estimated total of **`r report(tot[,"chum"])`** chum salmon were harvested.
    * An estimated total of **`r report(tot[,"sockeye"])`** sockeye salmon were harvested.
* Harvest by set nets accounted for an estimated **`r report(all.salmon.set)`** total salmon (**`r p.spp.set["chinook"]`%** Chinook salmon, **`r p.spp.set["chum"]`%** chum salmon, and **`r p.spp.set["sockeye"]`%** sockeye salmon).

\newpage

## All data, CBM weight x2

```{r}
# strata
strata = names(boat.trips)
n.strata = length(strata)

# pooling of information: which data should be used in each stratum?
# table(drift.dat$stratum)

use.A = c("A")
use.B = c("B")
use.C = c("C")
use.D1 = c("D1")

# containers: [iterations,species,strata]
rand.strat.drift = rand.strat.set = array(NA, dim = c(n.boot, 3, n.strata))
dimnames(rand.strat.drift) = dimnames(rand.strat.set) = list(1:n.boot, c("chinook", "chum", "sockeye"), strata)

keep.sources = c("CBM", "LE", "ADFG", "BBH", "FC")

# produce estimates with randomized data
for (i in 1:n.boot) {
  rand.strat.drift[i,,"A"] = estimate.harvest(dat = randomize.data(drift.dat[drift.dat$stratum %in% use.A & drift.dat$source %in% keep.sources,], CBM.weight = 100), n.trips = unname(boat.trips["A"]))
  rand.strat.drift[i,,"B"] = estimate.harvest(dat = randomize.data(drift.dat[drift.dat$stratum %in% use.B & drift.dat$source %in% keep.sources,], CBM.weight = 100), n.trips = unname(boat.trips["B"]))
  rand.strat.drift[i,,"C"] = estimate.harvest(dat = randomize.data(drift.dat[drift.dat$stratum %in% use.C & drift.dat$source %in% keep.sources,], CBM.weight = 100), n.trips = unname(boat.trips["C"]))
  rand.strat.drift[i,,"D1"] = estimate.harvest(dat = randomize.data(drift.dat[drift.dat$stratum %in% use.D1 & drift.dat$source %in% keep.sources,], CBM.weight = 100), n.trips = unname(boat.trips["D1"]))
  
  rand.strat.set[i,,"A"] = estimate.harvest(dat = randomize.data(set.dat, CBM.weight = 1), n.trips = unname(set.nets["A"]))
  rand.strat.set[i,,"B"] = estimate.harvest(dat = randomize.data(set.dat, CBM.weight = 1), n.trips = unname(set.nets["B"]))
  rand.strat.set[i,,"C"] = estimate.harvest(dat = randomize.data(set.dat, CBM.weight = 1), n.trips = unname(set.nets["C"]))
  rand.strat.set[i,,"D1"] = estimate.harvest(dat = randomize.data(set.dat, CBM.weight = 1), n.trips = unname(set.nets["D1"]))
  # rand.strat.set[i,,"A"] = 0
  # rand.strat.set[i,,"B"] = 0
  # rand.strat.set[i,,"C"] = 0
  # rand.strat.set[i,,"D1"] = 0
}

# estimate.harvest(dat = set.dat, n.trips = unname(set.nets["A"]))
# estimate.harvest(dat = set.dat, n.trips = unname(set.nets["B"]))
# estimate.harvest(dat = set.dat, n.trips = unname(set.nets["C"]))
# estimate.harvest(dat = set.dat, n.trips = unname(set.nets["D1"]))
# estimate.harvest(dat = drift.dat[drift.dat$stratum %in% use.A,], n.trips = unname(boat.trips["A"]))
# estimate.harvest(dat = drift.dat[drift.dat$stratum %in% use.B,], n.trips = unname(boat.trips["B"]))
# estimate.harvest(dat = drift.dat[drift.dat$stratum %in% use.C,], n.trips = unname(boat.trips["C"]))
# estimate.harvest(dat = drift.dat[drift.dat$stratum %in% use.D1,], n.trips = unname(boat.trips["D1"]))
```

```{r}

# NOTATION
  # if includes 'rand', these are estimates for each random data set
  # if includes 'strat', these are stratified by geographic stratum
  # if includes 'tot', these are summed across strata but not necessarily across gears
  # if includes 'drift', these are drift harvests only
  # if includes 'set', these are set harvest only
  # all objects (except 'all.salmon' ones) have species as the second dimension!!

# randomized harvest by stratum across both gears
rand.strat = rand.strat.drift + rand.strat.set

# randomized total harvest by drift boats across strata
rand.tot.drift = apply(rand.strat.drift, 2, rowSums)

# randomized total harvest by set netsacross strata
rand.tot.set = apply(rand.strat.set, 2, rowSums)

# randomized total harvest across gears across strata
rand.tot = rand.tot.drift + rand.tot.set

# randomized all salmon harvest
rand.all.salmon = rowSums(rand.tot)

# summarized total harvest by gear
tot.drift = apply(rand.tot.drift, 2, rand.summ)
tot.set = apply(rand.tot.set, 2, rand.summ)

# summarized total harvest across gears
tot = apply(rand.tot, 2, rand.summ, pretty = T)
# apply(rand.tot, 2, function(x) sd(x)/mean(x))

# summarized total salmon harvest
all.salmon = rand.summ(rand.all.salmon, pretty = T)

# summaries by stratum
strat.drift = strat.set = strat.tot = array(NA, dim = c(3, 3, 4))
strat.all.salmon.drift = matrix(NA, 3,4); rownames(strat.all.salmon.drift) = rownames(tot); colnames(strat.all.salmon.drift) = strata
strat.all.salmon.set = matrix(NA, 3,4); rownames(strat.all.salmon.set) = rownames(tot); colnames(strat.all.salmon.set) = strata
strat.all.salmon.tot = matrix(NA, 3,4); rownames(strat.all.salmon.tot) = rownames(tot); colnames(strat.all.salmon.tot) = strata
dimnames(strat.drift) = dimnames(strat.set) = dimnames(strat.tot) = list(rownames(tot), colnames(tot), strata)
for (s in 1:n.strata) {
  strat.drift[,,strata[s]] = apply(rand.strat.drift[,,strata[s]], 2, rand.summ)
  strat.set[,,strata[s]] = apply(rand.strat.set[,,strata[s]], 2, rand.summ)
  strat.tot[,,strata[s]] = apply(rand.strat[,,strata[s]], 2, rand.summ)
  
  strat.all.salmon.drift[,s] = rand.summ(rowSums(rand.strat.drift[,,strata[s]]))
  strat.all.salmon.set[,s] = rand.summ(rowSums(rand.strat.set[,,strata[s]]))
  strat.all.salmon.tot[,s] = rand.summ(rowSums(rand.strat.drift[,,strata[s]]) + rowSums(rand.strat.set[,,strata[s]]))
}

# rand.summ(rowSums(apply(rand.strat.drift,3,rowSums)))
# rand.summ(rowSums(apply(rand.strat.set,3,rowSums)))
# rand.summ(rowSums(apply(rand.strat.drift + rand.strat.set,3,rowSums)))

# calculate total chinook salmon harvest below BTF
# rand.chin.btf = rand.strat[,"chinook","A"] + rand.strat[,"chinook","B"] + rand.strat[,"chinook","C"] * 0.5
# mean(rand.chin.btf); sd(rand.chin.btf)

# calculate the total salmon harvest by set nets
rand.all.salmon.set = rowSums(rand.tot.set)
all.salmon.set = rand.summ(rand.all.salmon.set)

# calculate the proportion of set net harvest by species
rand.p.spp.set = t(apply(rand.tot.set, 1, function(x) x/sum(x)))
p.spp.set = apply(rand.p.spp.set, 2, rand.summ, rnd = 2)
p.spp.set = p.spp.set["mean",] * 100

tot.2cbm = tot
cv.2cbm = apply(rand.tot, 2, function(x) sd(x, na.rm = T)/mean(x, na.rm = T))
```

* An estimated total of **`r report(all.salmon)`** salmon were harvested.
    * An estimated total of **`r report(tot[,"chinook"])`** Chinook salmon were harvested.
    * An estimated total of **`r report(tot[,"chum"])`** chum salmon were harvested.
    * An estimated total of **`r report(tot[,"sockeye"])`** sockeye salmon were harvested.
* Harvest by set nets accounted for an estimated **`r report(all.salmon.set)`** total salmon (**`r p.spp.set["chinook"]`%** Chinook salmon, **`r p.spp.set["chum"]`%** chum salmon, and **`r p.spp.set["sockeye"]`%** sockeye salmon).



## Summary Tables

### Chinook Salmon
```{r, results = "asis"}

tab = rbind(tot.all[,"chinook"],
      tot.bbh[,"chinook"],
      tot.cbm[,"chinook"],
      tot.adfg[,"chinook"],
      tot.fc[,"chinook"],
      tot.le[,"chinook"],
      tot.2cbm[,"chinook"])

cv = paste(round(c(cv.all["chinook"], cv.bbh["chinook"], cv.cbm["chinook"], cv.adfg["chinook"], cv.fc["chinook"], cv.le["chinook"], cv.2cbm["chinook"]) * 100), "%", sep = "")

m = tab[,1]

m = as.numeric(gsub(x = m, ",", ""))
change = paste(round(((m - m[1])/m[1]) * 100), "%", sep = "")

tab = cbind(tab[,1], change, tab[,2:3])


scenario = c("All Data", "No BBH", "No CBM", "No ADF&G", "No FC", "No LE", "2xCBM")

tab = cbind(scenario, tab, cv)
colnames(tab) = c("Scenario", "Mean", "% Change", "2.5%", "97.5%", "CV")

pandoc.table(tab)

```

### Chum Salmon
```{r, results = "asis"}


tab = rbind(tot.all[,"chum"],
      tot.bbh[,"chum"],
      tot.cbm[,"chum"],
      tot.adfg[,"chum"],
      tot.fc[,"chum"],
      tot.le[,"chum"])

cv = paste(round(c(cv.all["chum"], cv.bbh["chum"], cv.cbm["chum"], cv.adfg["chum"], cv.fc["chum"], cv.le["chum"]) * 100), "%", sep = "")

m = tab[,1]

m = as.numeric(gsub(x = m, ",", ""))
change = paste(round(((m - m[1])/m[1]) * 100), "%", sep = "")

tab = cbind(tab[,1], change, tab[,2:3])


scenario = c("All Data", "No BBH", "No CBM", "No ADF&G", "No FC", "No LE")

tab = cbind(scenario, tab, cv)
colnames(tab) = c("Scenario", "Mean", "% Change", "2.5%", "97.5%", "CV")

pandoc.table(tab)
```

### Sockeye Salmon
```{r, results = "asis"}


tab = rbind(tot.all[,"sockeye"],
      tot.bbh[,"sockeye"],
      tot.cbm[,"sockeye"],
      tot.adfg[,"sockeye"],
      tot.fc[,"sockeye"],
      tot.le[,"sockeye"])

cv = paste(round(c(cv.all["sockeye"], cv.bbh["sockeye"], cv.cbm["sockeye"], cv.adfg["sockeye"], cv.fc["sockeye"], cv.le["sockeye"]) * 100), "%", sep = "")

m = tab[,1]

m = as.numeric(gsub(x = m, ",", ""))
change = paste(round(((m - m[1])/m[1]) * 100), "%", sep = "")

tab = cbind(tab[,1], change, tab[,2:3])


scenario = c("All Data", "No BBH", "No CBM", "No ADF&G", "No FC", "No LE")

tab = cbind(scenario, tab, cv)
colnames(tab) = c("Scenario", "Mean", "% Change", "2.5%", "97.5%", "CV")

pandoc.table(tab)
```


\newpage

# Are the Missing Soak Interviews at BBH Missing At Random?
```{r}
bbh.dat

bad = bbh.dat[is.na(bbh.dat$soak.hrs),]
good = bbh.dat[!is.na(bbh.dat$soak.hrs),]

chin.test = perm.test(y1 = bad$chinook, y2 = good$chinook, do.plot = F)
chum.test = perm.test(y1 = bad$chum, y2 = good$chum, do.plot = F)
sock.test = perm.test(y1 = bad$sockeye, y2 = good$sockeye, do.plot = F)
length.test = perm.test(y1 = bad$length, y2 = good$length, do.plot = F)
dur.test = perm.test(y1 = bad$trip.end - bad$trip.start, y2 = good$trip.end - good$trip.start, do.plot = F)
start.test = perm.test(y1 = bad$trip.start, y2 = good$trip.start, do.plot = F)
stop.test = perm.test(y1 = bad$trip.end, y2 = good$trip.end, do.plot = F)
```

_Difference is soak time present interview mean - soak time absent interview mean_

_P-value <0.05 indicates there is a statistically-important difference in the means_

_Permutation test used to get P-value_

**Chinook Catch/Trip**

*  Difference in Mean: `r round(chin.test$diff,2)`
*  P-value: `r round(chin.test$p, 2)`

**Chum Catch/Trip**

*  Difference in Mean: `r round(chum.test$diff,2)`
*  P-value: `r round(chum.test$p, 2)`

**Sockeye Catch/Trip**

*  Difference in Mean: `r round(sock.test$diff,2)`
*  P-value: `r round(sock.test$p, 2)`

**Net Length**

*  Difference in Mean: `r round(length.test$diff,2)`
*  P-value: `r round(length.test$p, 2)`

**Trip Duration**

*  Difference in Mean: `r round(dur.test$diff,2)`
*  P-value: `r round(dur.test$p, 2)`

**Trip Start Time**

*  Difference in Mean: `r round(start.test$diff,2)`
*  P-value: `r round(start.test$p, 2)`

**Trip End Time**

*  Difference in Mean: `r round(stop.test$diff,2)`
*  P-value: `r round(stop.test$p, 2)`

