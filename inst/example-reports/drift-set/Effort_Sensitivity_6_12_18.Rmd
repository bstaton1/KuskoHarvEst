---
title: "Effort Sensitivity"
subtitle: "6/12/2018 Opportunity"
output:
  pdf_document:
    toc: true
linkcolor: "blue"
---

```{r Markdown Setup, include = F}
knitr::opts_chunk$set(echo = FALSE, fig.align = "center", warning = F, message = F, results = "hide", fig.height = 6, fig.width = 9)
```

```{r Session Setup}
library(pander)

# clear the workspace
rm(list = ls(all = T))

# the directory where all data files are located
# data_dir = "C:/Users/bstaton/Documents/StatonWork/Inseason Harvest Estimates/6_12_17"
# data_dir = "C:/Users/bas0041/Dropbox/PhD Project/USFWS Work/2017/Inseason Harvest Estimates/6_12_17"
data_dir = "C:/Users/bstaton/Documents/StatonWork/2_Harvest Estimates/6_12_18_TA/"

# set global table option to never break table on two rows
panderOptions(o = "table.split.table", value = Inf) 

# read functions into workspace
message = F
# source("C:/Users/bas0041/Dropbox/PhD Project/USFWS Work/2017/Inseason Harvest Estimates/Functions_Source.R")
source("C:/Users/bstaton/Documents/StatonWork/2_Harvest Estimates/Functions_Source.R")

# the date in file names
dFile = "6_12_18"
```

```{r Dates to Keep}
# the dates to keep in the rest of the analysis.
# THIS IS KEY, OTHERWISE YOU COULD USE THE WRONG CATCH AND EFFORT DATA!!!
keep.dates = c("6/12")
```

```{r Step 1: Prepare All Data}
# the columns in the right order for all interview data sets
cols = c("source", "date", "stratum", "trip.start", "trip.end", "soak.hrs", "length", 
         "gear", "mesh", "chinook", "chum", "sockeye", "chinook.cpe", "chum.cpe", "sockeye.cpe")

# read in raw interview files
cbm.raw.dat = read.csv(paste(data_dir, file_name("CBM", dFile), sep = "/"), stringsAsFactors = F)
bbh.raw.dat = read.csv(paste(data_dir, file_name("BBH", dFile), sep = "/"), stringsAsFactors = F)
adfg.raw.dat = read.csv(paste(data_dir, file_name("ADFG", dFile), sep = "/"), stringsAsFactors = F)
fc.raw.dat = read.csv(paste(data_dir, file_name("FC", dFile), sep = "/"), stringsAsFactors = F)

# read in raw flight data
flight.dat.raw = read.csv(paste(data_dir, file_name("Flight_counts", dFile), sep = "/"), stringsAsFactors = F)

# PREPARE BETHEL BOAT HARBOR DATA
bbh.dat = bbh.prep(bbh.raw.dat)
# remove questionable entries for now
bbh.dat = bbh.dat[-which(bbh.dat$length %in% c(25, 35) | bbh.dat$mesh > 8),]


# PREPARE COMMUNITY BASED MONITORING DATA
cbm.dat = cbm.prep(dat = cbm.raw.dat)
cbm.goals = cbm.dat$goals
cbm.dat = cbm.dat$catch.effort

# adfg data
adfg.dat = cbm.prep(dat = adfg.raw.dat)
adfg.goals = adfg.dat$goals
adfg.dat = adfg.dat$catch.effort
# adfg.dat$source = "ADFG"

# PREPARE BETHEL AREA FISH CAMP DATA
fc.dat = fc.prep(dat = fc.raw.dat)

# COMBINE ALL DATASETS INTO ONE
dat = rbind(bbh.dat, adfg.dat, cbm.dat, fc.dat)

# KEEP ONLY THE DATES OF INTEREST
dat = dat[dat$date %in% keep.dates,]

# SEPARATE INTERVIEW DATA BY GEAR TYPES
interviews = dat[dat$gear == "drift",]

# PREPARE FLIGHT DATA
flight.dat = flight.prep(dat = flight.dat.raw)
```

\newpage

# Sensitivity to the Removal of Flights

## All Flight Data
```{r}
f123 = effort_sensitivity_3(trip.dat = interviews[,c("trip.start", "trip.end")], flight.dat = flight.dat, main = NULL)
```
[Return to Table of Contents](#TOC)
\newpage

## First and Second Flights Only

```{r}
f12 = effort_sensitivity_2(trip.dat = interviews[,c("trip.start", "trip.end")], flight.dat = flight.dat, main = NULL)
```
[Return to Table of Contents](#TOC)
\newpage

## First and Third Flights Only
```{r}
tmp_flight_dat = list(f1.times = flight.dat$f1.times,
                      f2.times = flight.dat$f3.times,
                      drift.tot = flight.dat$drift.tot[1:3])
f13 = effort_sensitivity_2(trip.dat = interviews[,c("trip.start", "trip.end")], flight.dat = tmp_flight_dat, main = NULL)
rm(tmp_flight_dat)
```
[Return to Table of Contents](#TOC)
\newpage

## Second and Third Flights Only

```{r}
tmp_flight_dat = list(f1.times = flight.dat$f2.times,
                      f2.times = flight.dat$f3.times,
                      drift.tot = flight.dat$drift.tot[2:3])
f23 = effort_sensitivity_2(trip.dat = interviews[,c("trip.start", "trip.end")], flight.dat = tmp_flight_dat, main = NULL)
rm(tmp_flight_dat)
```
[Return to Table of Contents](#TOC)
\newpage

## First Flight Only
```{r}
tmp_flight_dat = list(f1.times = flight.dat$f1.times,
                      drift.tot = flight.dat$drift.tot[1])
f1 = effort_sensitivity_1(trip.dat = interviews[,c("trip.start", "trip.end")], flight.dat = tmp_flight_dat, main = NULL)
rm(tmp_flight_dat)
```
[Return to Table of Contents](#TOC)
\newpage

## Second Flight Only
```{r}
tmp_flight_dat = list(f1.times = flight.dat$f2.times,
                      drift.tot = flight.dat$drift.tot[2])
f2 = effort_sensitivity_1(trip.dat = interviews[,c("trip.start", "trip.end")], flight.dat = tmp_flight_dat, main = NULL)
rm(tmp_flight_dat)
```
[Return to Table of Contents](#TOC)
\newpage

## Third Flight Only
```{r}
tmp_flight_dat = list(f1.times = flight.dat$f3.times,
                      drift.tot = flight.dat$drift.tot[3])
f3 = effort_sensitivity_1(trip.dat = interviews[,c("trip.start", "trip.end")], flight.dat = tmp_flight_dat, main = NULL)
rm(tmp_flight_dat)
```
[Return to Table of Contents](#TOC)
\newpage

## Summary Table

```{r results = "asis"}

total_boats = c(f123["total.b"], f12["total.b"], f13["total.b"], f23["total.b"], f1["total.b"], f2["total.b"],f3["total.b"])
p_old1 = round(c(f123["p.old1"], f12["p.old1"], f13["p.old1"], f23["p.old1"], f1["p.old1"], f2["p.old1"],f3["p.old1"]), 2)
p_old2 = round(c(f123["p.old2"], f12["p.old2"], f13["p.old2"], f23["p.old2"], f1["p.old2"], f2["p.old2"],f3["p.old2"]), 2)
uncounted_boats = round(c(f123["trips.not.counted"], f12["trips.not.counted"], f13["trips.not.counted"], f23["trips.not.counted"], f1["trips.not.counted"], f2["trips.not.counted"],f3["trips.not.counted"]), 0)

change = paste(round((total_boats - total_boats[1])/total_boats[1], 2) * 100, "%", sep = "")
tab = cbind(total_boats, change, p_old1, p_old2, uncounted_boats)
rownames(tab) = NULL

flights = c("1,2,3", "1,2", "1,3", "2,3", "1", "2", "3")

tab = cbind(flights, tab)

colnames(tab) = c("Scenario", "Total Estimate", "% Change", "P(F1 & F2)", "P(F2 & F3)", "Unobserved Trips")

pandoc.table(tab, missing = "--")

```
[Return to Table of Contents](#TOC)
\newpage

# Sensitivity to the Removal of Interview Data

_FOR THIS ANALYSIS ONLY, ADFG DATA FROM KASIGLUK ARE GROUPED WITH THE CBM DATA_

## All Data
```{r}
keep = c("CBM", "BBH", "FC")
cbf = effort_sensitivity_3(trip.dat = interviews[interviews$source %in% keep,c("trip.start", "trip.end")], flight.dat = flight.dat, main = NULL)
rm(tmp_flight_dat)
```
[Return to Table of Contents](#TOC)
\newpage

## CBM and BBH Only
```{r}
keep = c("CBM", "BBH")
cb = effort_sensitivity_3(trip.dat = interviews[interviews$source %in% keep,c("trip.start", "trip.end")], flight.dat = flight.dat, main = NULL)
rm(tmp_flight_dat)
```
[Return to Table of Contents](#TOC)
\newpage

## CBM and FC Only
```{r}
keep = c("CBM", "FC")
cf = effort_sensitivity_3(trip.dat = interviews[interviews$source %in% keep,c("trip.start", "trip.end")], flight.dat = flight.dat, main = NULL)
rm(tmp_flight_dat)
```
[Return to Table of Contents](#TOC)
\newpage

## BBH and FC Only
```{r}
keep = c("BBH", "FC")
bf = effort_sensitivity_3(trip.dat = interviews[interviews$source %in% keep,c("trip.start", "trip.end")], flight.dat = flight.dat, main = NULL)
rm(tmp_flight_dat)
```
[Return to Table of Contents](#TOC)
\newpage

## CBM Only
```{r}
keep = c("CBM")
c = effort_sensitivity_3(trip.dat = interviews[interviews$source %in% keep,c("trip.start", "trip.end")], flight.dat = flight.dat, main = NULL)
rm(tmp_flight_dat)
```
[Return to Table of Contents](#TOC)
\newpage

## BBH Only
```{r}
keep = c("BBH")
b = effort_sensitivity_3(trip.dat = interviews[interviews$source %in% keep,c("trip.start", "trip.end")], flight.dat = flight.dat, main = NULL)
rm(tmp_flight_dat)
```
[Return to Table of Contents](#TOC)
\newpage

## FC Only
```{r}
keep = c("FC")
f = effort_sensitivity_3(trip.dat = interviews[interviews$source %in% keep,c("trip.start", "trip.end")], flight.dat = flight.dat, main = NULL)
rm(tmp_flight_dat)
```
[Return to Table of Contents](#TOC)
\newpage

## Summary Table

```{r results = "asis"}

total_boats = c(cbf["total.b"], cb["total.b"], cf["total.b"], bf["total.b"], c["total.b"], b["total.b"],f["total.b"])
p_old1 = round(c(cbf["p.old1"], cb["p.old1"], cf["p.old1"], bf["p.old1"], c["p.old1"], b["p.old1"],f["p.old1"]), 2)
p_old2 = round(c(cbf["p.old2"], cb["p.old2"], cf["p.old2"], bf["p.old2"], c["p.old2"], b["p.old2"],f["p.old2"]), 2)
uncounted_boats = round(c(cbf["trips.not.counted"], cb["trips.not.counted"], cf["trips.not.counted"], bf["trips.not.counted"], c["trips.not.counted"], b["trips.not.counted"],f["trips.not.counted"]), 0)

change = paste(round((total_boats - total_boats[1])/total_boats[1], 2) * 100, "%", sep = "")
tab = cbind(total_boats, change, p_old1, p_old2, uncounted_boats)
rownames(tab) = NULL

scenario = c("CBM,BBH,FC", "CBM,BBH", "CBM,FC", "BBH,FC", "CBM", "BBH", "FC")

tab = cbind(scenario, tab)

colnames(tab) = c("Scenario", "Total Estimate", "% Change", "P(F1 & F2)", "P(F2 & F3)", "Unobserved Trips")

pandoc.table(tab, missing = "--")

```

[Return to Table of Contents](#TOC)
