---
title: "Kuskokwim River In-season Harvest and Effort Estimates"
draft-watermark: false
output: 
  pdf_document:
    template: "early-template.tex"
geometry: [top=0.5in,right=0.75in,bottom=0.75in,left=0.75in]
number-sections: false
fontsize: 11pt
editor_options: 
  chunk_output_type: console
opener-label: "6/12/2018 Subsistence Harvest Opportunity"
opener-start: "6/12/2018 10:00 AM"
opener-end: "6/12/2018 10:00 PM"
area: "Tuntutuliak -- Akiak"
special-action-url: http://example.com
news-release-url: http://example.com
contact: "Ben Staton (bstaton.qes@gmail.com)"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, fig.align = "center", warning = FALSE, fig.pos = "H", out.extra = "")
knitr::opts_knit$set(root.dir = "../")
library(magrittr)
```

```{r KuskoHarvEst setup, include = FALSE}
library(KuskoHarvEst)

# set options for function behavior
options(
  soak_sd_cut = 3, 
  net_length_cut = 350, 
  central_fn = mean, 
  pooling_threshold = 10
)

# the date to try out
try_date = "2018_06_12"

# where are the data located
base_dir = "inst/example-data"

# the names of the data files in that directory
input_files = list.files(file.path(base_dir, try_date), full.names = TRUE)

# extract those that are specific to interviews and flights
flight_file = input_files[stringr::str_which(input_files, "Flight_counts")]
interview_files = input_files[-stringr::str_which(input_files, "Flight_counts")]

histogram_gear = "drift"
```

# Data Sources {-}

```{r data-prep}
# read in and format raw interview data files
interview_data = prepare_interviews_all(interview_files, include_village = TRUE)

# read in and format raw flight data file
flight_data = prepare_flights(flight_file)
```

```{r interview-sources-table}
interview_data_table(interview_data)
```

Of these interviews, **`r sum(interview_data$gear == "drift")`** were from drift nets and **`r sum(interview_data$gear == "set")`** were from set nets.

```{r flight-table}
flight_data_table(flight_data)
```

# Effort Estimates {-} 

```{r estimate-effort}
# estimate drift net effort
drift_effort_info = estimate_effort(interview_data, flight_data, "drift", method = "dbl_exp")

# estimate set net effort
set_effort_info = estimate_effort(interview_data, flight_data, "set", method = "max_per_stratum")
```

* An estimated **`r drift_effort_info$effort_est_total`** total drift boat trips occurred.
  * An estimated **`r percentize(drift_effort_info$p_T1_given_T2[1])`** of the trips counted on flight 2 were also counted on flight 1.
  * An estimated **`r percentize(drift_effort_info$p_T1_given_T2[2])`** of the trips counted on flight 3 were also counted on flight 2.
  * An estimated **`r round(drift_effort_info$trip_counts["not_counted"] * drift_effort_info$effort_per_interview)`** trips were not counted during any flights.
* An estimated **`r set_effort_info$effort_est_total`** total set net trips occurred.

# Harvest Estimates {-}

```{r estimate-harvest, eval = TRUE}
# estimate (via bootstrap) drift net harvest for all species and and strata
boot_out_drift = bootstrap_harvest(interview_data, drift_effort_info,
                                   gear = "drift", n_boot = 100, stratify_interviews = TRUE)

# estimate (via bootstrap) set net harvest for all species and and strata
boot_out_set = bootstrap_harvest(interview_data, set_effort_info,
                                 gear = "set", n_boot = 100, stratify_interviews = FALSE)

# sum up across gears
boot_out_total = cbind(iter = boot_out_drift$iter, 
                       gear = "total", 
                       stratum = boot_out_drift$stratum,
                       boot_out_drift[,-c(1:3)] + boot_out_set[,-c(1:3)])

# combine drift, set, and total into one data frame of bootstrap output
# this object is used to make all harvest-related inference from here on
boot_out = rbind(boot_out_total, boot_out_drift, boot_out_set)
```

```{r}
set_harvest = sapply(c("chinook", "chum", "sockeye", "total"), function(sp) report(sp, gear = "set", CI = FALSE, return_numeric = TRUE))
set_spp = percentize(set_harvest[c("chinook", "chum", "sockeye")]/set_harvest["total"])
```

* An estimated total of **`r report()`** salmon were harvested.
  *  An estimated total of **`r report(spp = "chinook")`** Chinook salmon were harvested.
  *  An estimated total of **`r report(spp = "chum")`** chum salmon were harvested.
  *  An estimated total of **`r report(spp = "sockeye")`** sockeye salmon were harvested.
* Harvest by set nets accounted for an estimated **`r report(gear = "set")`** total salmon (`r paste0(set_spp["chinook"], " Chinook salmon, ", set_spp["chum"], " chum salmon, and ", set_spp["sockeye"], " sockeye salmon")`).

```{r strata-summary-table}
strata_summary_table("drift")
```

```{r johnson-summary-table}
johnson_summary_table()
```

```{r histograms, fig.width = 7.5, fig.height = 3.75, fig.cap = make_histogram_caption(interview_data, histogram_gear)}
make_all_histograms(interview_data, histogram_gear, c("total_salmon", "chinook", "chum+sockeye", "trip_duration", "soak_duration", "p_chinook"))
```

```{r trip-time-plot, fig.width = 7, fig.height = 4, eval = FALSE}
effort_plot(flight_data, drift_effort_info)
```

\clearpage
\setcounter{page}{1}
\setcounter{figure}{0}
\setcounter{table}{0}
\renewcommand\thesection{A\arabic{section}}
\renewcommand\thesubsection{A\arabic{section}.\arabic{subsection}}
\renewcommand\thesubsubsection{A\arabic{section}.\arabic{subsection}.\arabic{subsubsection}}
\renewcommand\thepage{A\arabic{page}}
\renewcommand\thefigure{A\arabic{figure}}
\renewcommand\thetable{A\arabic{table}}

# Appendix: Detailed Interview Summaries {-}

**Column Meanings**

* **Area**: the area of the river the trip occurred in
* **N**: the number of interviews with usable information in each area
* **Min**: the minimum value among all trips in each area
* **25%**: the value that 25% of the trips fell below in each area
* **Mean**: the average value across all trips in each area
* **75%**: the value that 75% of the trips fell below in each area
* **Max**: the maximum value among all trips in each area

```{r}
appendix_gear = "set"
```

```{r}
make_appendix_table(interview_data, appendix_gear, "chinook_rate")
```

```{r}
make_appendix_table(interview_data, appendix_gear, "chinook")
```

```{r}
make_appendix_table(interview_data, appendix_gear, "chum+sockeye_rate")
```

```{r}
make_appendix_table(interview_data, appendix_gear, "chum+sockeye")
```

```{r}
make_appendix_table(interview_data, appendix_gear, "p_chinook")
```

```{r}
make_appendix_table(interview_data, appendix_gear, "soak_duration")
```

```{r}
make_appendix_table(interview_data, appendix_gear, "trip_duration")
```

```{r}
make_appendix_table(interview_data, appendix_gear, "trip_start")
```

```{r}
make_appendix_table(interview_data, appendix_gear, "trip_end")
```
